<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Inventario - Frecuencia de Repuestos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #3f72af;
      --color-secondary: #dbe2ef;
      --color-text: #112d4e;
      --color-accent: #2c5282;
      --color-success: #2ecc71;
      --color-error: #e74c3c;
      --color-warning: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      --header-bg-color: #2c5282;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--color-text);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background-color: var(--header-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    h2 {
      margin-top: 30px;
      font-size: 1.5rem;
    }

    h3 {
      text-align: left;
      color: var(--color-primary);
      border-bottom: none;
      padding-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: white;
      padding: 5px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .title-container {
      flex: 1;
    }

    .subtitle {
      text-align: center;
      color: #dbe2ef;
      margin-top: -10px;
      font-size: 1.1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--color-error);
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--color-primary);
    }

    .btn-info:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-print {
      background: #17a2b8;
    }

    .btn-print:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .status-message {
      padding: 15px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .success {
      background-color: #d4edda;
      color: var(--color-success);
      border-left: 4px solid var(--color-success);
    }

    .info {
      background-color: #e7f5ff;
      color: var(--color-primary);
      border-left: 4px solid var(--color-primary);
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .connection-success {
      background-color: var(--color-success);
      color: white;
    }

    .connection-error {
      background-color: var(--color-error);
      color: white;
    }

    .connection-loading {
      background-color: var(--color-primary);
      color: white;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .input-group input, 
    .input-group select, 
    .input-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .resultados-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
    }

    .tabla-resultados {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .tabla-resultados th {
      background-color: var(--color-primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .tabla-resultados td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tabla-resultados tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .tabla-resultados tr:hover {
      background-color: #f1f1f1;
    }

    /* Estilos para gráficos */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Estilos para filtros */
    .filters-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* Estilos para selector de períodos */
    .periodo-selector-container {
      margin-bottom: 20px;
    }

    .periodo-selector-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .periodo-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .periodo-btn {
      padding: 10px 20px;
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
      flex: 1;
      min-width: 120px;
      max-width: 150px;
    }

    .periodo-btn.active {
      background-color: var(--color-primary);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .periodo-btn:hover:not(.active) {
      background-color: var(--color-secondary);
    }

    /* Estilos para estadísticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para ranking */
    .ranking-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .ranking-card {
      flex: 1;
      min-width: 300px;
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .ranking-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .ranking-position {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .ranking-position.top-1 {
      background-color: #FFD700;
    }

    .ranking-position.top-2 {
      background-color: #C0C0C0;
    }

    .ranking-position.top-3 {
      background-color: #CD7F32;
    }

    .ranking-info {
      flex: 1;
    }

    .ranking-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .ranking-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para modal de selección de datos */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .modal-title {
      color: var(--color-primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .close-modal:hover {
      color: var(--color-error);
    }

    .data-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .data-selection-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .data-selection-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .data-selection-item label {
      font-weight: normal;
      margin-bottom: 0;
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .header-container {
        background-color: white !important;
        color: black !important;
        box-shadow: none;
        border: 1px solid #ddd;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .btn, .btn-group {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
      }

      .subtitle {
        color: #555 !important;
      }

      .ranking-container {
        flex-direction: column;
      }
      
      .ranking-card {
        min-width: 100%;
      }
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-wrapper {
        height: 250px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .ranking-container {
        flex-direction: column;
      }
      
      .ranking-card {
        min-width: 100%;
      }
      
      .periodo-selector {
        flex-direction: column;
      }
      
      .periodo-btn {
        max-width: 100%;
      }
      
      .data-selection-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container">
        <div class="logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div>
          <h1>Control de Inventario</h1>
          <div class="subtitle">Análisis de Frecuencia de Repuestos</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-print" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>

    <div id="error-message" class="status-message error" style="display: none;"></div>
    <div id="success-message" class="status-message success" style="display: none;"></div>

    <div class="filters-container">
      <h3>Configuración del Informe</h3>
      
      <!-- Selector de períodos como etiquetas -->
      <div class="periodo-selector-container">
        <label class="periodo-selector-label">Seleccione el período:</label>
        <div class="periodo-selector">
          <div class="periodo-btn active" data-periodo="dia">Día</div>
          <div class="periodo-btn" data-periodo="semana">Semana</div>
          <div class="periodo-btn" data-periodo="mes">Mes</div>
          <div class="periodo-btn" data-periodo="bimestre">Bimestre</div>
          <div class="periodo-btn" data-periodo="trimestre">Trimestre</div>
          <div class="periodo-btn" data-periodo="cuatrimestre">Cuatrimestre</div>
          <div class="periodo-btn" data-periodo="semestre">Semestre</div>
          <div class="periodo-btn" data-periodo="anio">Año</div>
          <div class="periodo-btn" data-periodo="personalizado">Personalizado</div>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group" id="fecha-personalizada-group" style="display: none;">
          <label for="fecha-personalizada">Fecha:</label>
          <input type="date" id="fecha-personalizada">
        </div>
        <div class="filter-group" id="fecha-inicio-group" style="display: none;">
          <label for="fecha-inicio">Fecha de Inicio:</label>
          <input type="date" id="fecha-inicio">
        </div>
        <div class="filter-group" id="fecha-fin-group" style="display: none;">
          <label for="fecha-fin">Fecha de Fin:</label>
          <input type="date" id="fecha-fin">
        </div>
        <div class="filter-group">
          <label for="patente-filtro">Patente:</label>
          <select id="patente-filtro">
            <option value="">Todas las máquinas</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label for="mostrar-top">Mostrar:</label>
          <select id="mostrar-top">
            <option value="0">Todos los repuestos</option>
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="30">Top 30</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="ordenar-por">Ordenar por:</label>
          <select id="ordenar-por">
            <option value="unidades">Unidades</option>
            <option value="valor">Valor</option>
            <option value="frecuencia">Frecuencia</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
        <button class="btn btn-primary" onclick="mostrarModalSeleccionDatos()">
          <i class="fas fa-file-alt"></i> Generar Informe
        </button>
      </div>
    </div>

    <!-- Modal para selección de datos -->
    <div id="modal-seleccion-datos" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Seleccionar Datos para el Informe</h3>
          <button class="close-modal" onclick="cerrarModalSeleccionDatos()">&times;</button>
        </div>
        <p>Seleccione qué elementos desea incluir en el informe:</p>
        
        <div class="data-selection-grid">
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-estadisticas" checked>
            <label for="mostrar-estadisticas">Estadísticas Generales</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-ranking" checked>
            <label for="mostrar-ranking">Ranking de Repuestos</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-graficos" checked>
            <label for="mostrar-graficos">Gráficos de Frecuencia</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-detalle" checked>
            <label for="mostrar-detalle">Tabla de Detalle</label>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cerrarModalSeleccionDatos()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-success" onclick="generarInforme()">
            <i class="fas fa-check"></i> Generar Informe
          </button>
        </div>
      </div>
    </div>

    <div class="stats-container" id="stats-container">
      <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

    <div class="resultados-container" id="ranking-container">
      <h3>Ranking de Repuestos Más Utilizados</h3>
      <div class="ranking-container" id="ranking-cards-container">
        <!-- El ranking se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="graficos-container">
      <h3>Gráficos de Frecuencia de Repuestos</h3>
      <div class="charts-container">
        <div class="chart-card">
          <h4 class="chart-title">Top 10 Repuestos por Unidades</h4>
          <div class="chart-wrapper">
            <canvas id="chart-top-unidades"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Top 10 Repuestos por Valor</h4>
          <div class="chart-wrapper">
            <canvas id="chart-top-valor"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Distribución por Frecuencia de Uso</h4>
          <div class="chart-wrapper">
            <canvas id="chart-distribucion-frecuencia"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Evolución de Repuestos Más Usados</h4>
          <div class="chart-wrapper">
            <canvas id="chart-evolucion-repuestos"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="resultados-container" id="detalle-container">
      <h3>Detalle de Repuestos Utilizados</h3>
      <table class="tabla-resultados" id="tabla-detalle">
        <thead>
          <tr>
            <th>Posición</th>
            <th>Código</th>
            <th>Producto</th>
            <th>Unidades</th>
            <th>Valor Total ($)</th>
            <th>Frecuencia</th>
            <th>Última Fecha</th>
            <th>Máquinas</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div id="connection-status" class="connection-status connection-loading" style="display: none;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a la base de datos...
    </div>

    <script>
      // Variables globales
      let supabaseClient;
      let maquinasBase = [];
      let productosBase = [];
      let datosProcesados = null;
      let charts = {};
      let configuracionInforme = {
        mostrarEstadisticas: true,
        mostrarRanking: true,
        mostrarGraficos: true,
        mostrarDetalle: true
      };
      let periodoSeleccionado = 'mes'; // Período por defecto

      // Función para inicializar Supabase
      async function inicializarSupabase() {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.style.display = 'block';

        try {
          // Configuración de Supabase - Reemplaza con tus credenciales
          const supabaseUrl = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';

          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

          // Verificar conexión obteniendo datos necesarios
          const [maquinas, productos] = await Promise.all([
            obtenerMaquinas(),
            obtenerProductosCatalogo()
          ]);

          connectionStatus.className = 'connection-status connection-success';
          connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a la base de datos';

          setTimeout(() => {
            connectionStatus.style.display = 'none';
          }, 3000);

          // Actualizar lista de patentes
          if (maquinas && maquinas.length > 0) {
            maquinasBase = maquinas;
            const selectPatente = document.getElementById('patente-filtro');
            maquinas.forEach(maquina => {
              const option = document.createElement('option');
              option.value = maquina.patente;
              option.textContent = maquina.patente;
              selectPatente.appendChild(option);
            });
          }

          // Actualizar lista de productos
          if (productos && productos.length > 0) {
            productosBase = productos;
          }

          // Configurar fechas por defecto (último mes)
          const fechaFin = new Date();
          const fechaInicio = new Date();
          fechaInicio.setMonth(fechaInicio.getMonth() - 1);
          
          document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
          document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
          document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];

          // Cargar datos iniciales
          await cargarDatosRepuestos();

          return true;
        } catch (error) {
          console.error('Error al conectar con Supabase:', error);
          connectionStatus.className = 'connection-status connection-error';
          connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
          mostrarError(`Error al conectar con la base de datos: ${error.message}`);
          return false;
        }
      }

      // Función para obtener máquinas
      async function obtenerMaquinas() {
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('patente')
          .order('patente', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener productos del catálogo
      async function obtenerProductosCatalogo() {
        const { data, error } = await supabaseClient
          .from('productos')
          .select('id, codigo, nombre_producto')
          .order('id', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener datos de repuestos por frecuencia
      async function obtenerRepuestosPorFrecuencia(fechaInicio, fechaFin, patente) {
        let query = supabaseClient
          .from('registros')
          .select('*')
          .eq('estado', 'salida')
          .gte('fecha', fechaInicio)
          .lte('fecha', fechaFin)
          .order('fecha', { ascending: false });

        // Aplicar filtro de patente si se seleccionó
        if (patente) {
          query = query.eq('patente', patente);
        }

        const { data, error } = await query;

        if (error) throw error;
        return data;
      }

      // Función para calcular fechas según período seleccionado
      function calcularFechasPorPeriodo(periodo) {
        const fechaFin = new Date();
        let fechaInicio = new Date();
        
        switch(periodo) {
          case 'dia':
            fechaInicio.setDate(fechaFin.getDate() - 1);
            break;
          case 'semana':
            fechaInicio.setDate(fechaFin.getDate() - 7);
            break;
          case 'mes':
            fechaInicio.setMonth(fechaFin.getMonth() - 1);
            break;
          case 'bimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 2);
            break;
          case 'trimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 3);
            break;
          case 'cuatrimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 4);
            break;
          case 'semestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 6);
            break;
          case 'anio':
            fechaInicio.setFullYear(fechaFin.getFullYear() - 1);
            break;
          case 'personalizado':
            // Para personalizado, usamos las fechas del formulario
            const fechaInicioInput = document.getElementById('fecha-inicio').value;
            const fechaFinInput = document.getElementById('fecha-fin').value;
            
            if (fechaInicioInput && fechaFinInput) {
              fechaInicio = new Date(fechaInicioInput);
              fechaFin = new Date(fechaFinInput);
            } else {
              // Por defecto, último mes
              fechaInicio.setMonth(fechaFin.getMonth() - 1);
            }
            break;
        }
        
        return {
          fechaInicio: fechaInicio.toISOString().split('T')[0],
          fechaFin: fechaFin.toISOString().split('T')[0]
        };
      }

      // Función para procesar datos de frecuencia
      function procesarDatosFrecuencia(datos) {
        const productosAgrupados = {};
        
        datos.forEach(item => {
          const clave = item.codigo;
          if (!productosAgrupados[clave]) {
            productosAgrupados[clave] = {
              codigo: item.codigo,
              nombre: item.nombre,
              unidades: 0,
              valor: 0,
              frecuencia: 0,
              ultimaFecha: item.fecha,
              maquinas: new Set()
            };
          }
          
          productosAgrupados[clave].unidades += item.unidades || 0;
          productosAgrupados[clave].valor += item.precio_total || 0;
          productosAgrupados[clave].frecuencia += 1;
          
          // Actualizar última fecha si es más reciente
          if (new Date(item.fecha) > new Date(productosAgrupados[clave].ultimaFecha)) {
            productosAgrupados[clave].ultimaFecha = item.fecha;
          }
          
          // Agregar máquina al conjunto
          if (item.patente) {
            productosAgrupados[clave].maquinas.add(item.patente);
          }
        });

        // Convertir Set a Array para contar máquinas
        Object.keys(productosAgrupados).forEach(codigo => {
          productosAgrupados[codigo].maquinas = Array.from(productosAgrupados[codigo].maquinas);
        });

        // Convertir a array
        return Object.values(productosAgrupados);
      }

      // Función para cargar datos de repuestos
      async function cargarDatosRepuestos() {
        try {
          // Obtener valores de filtros
          const patente = document.getElementById('patente-filtro').value;
          const mostrarTop = parseInt(document.getElementById('mostrar-top').value);
          const ordenarPor = document.getElementById('ordenar-por').value;

          // Calcular fechas según período
          const fechas = calcularFechasPorPeriodo(periodoSeleccionado);

          // Obtener datos
          const datos = await obtenerRepuestosPorFrecuencia(
            fechas.fechaInicio, 
            fechas.fechaFin, 
            patente
          );

          // Procesar datos por frecuencia
          let datosProcesados = procesarDatosFrecuencia(datos);

          // Ordenar según criterio seleccionado
          switch(ordenarPor) {
            case 'unidades':
              datosProcesados.sort((a, b) => b.unidades - a.unidades);
              break;
            case 'valor':
              datosProcesados.sort((a, b) => b.valor - a.valor);
              break;
            case 'frecuencia':
              datosProcesados.sort((a, b) => b.frecuencia - a.frecuencia);
              break;
          }

          // Aplicar filtro de top si es necesario
          if (mostrarTop > 0) {
            datosProcesados = datosProcesados.slice(0, mostrarTop);
          }

          // Actualizar interfaz según configuración
          actualizarVistaInforme(datosProcesados);

        } catch (error) {
          console.error('Error al cargar datos de repuestos:', error);
          mostrarError('Error al cargar datos: ' + error.message);
        }
      }

      // Función para actualizar la vista según la configuración del informe
      function actualizarVistaInforme(datosProcesados) {
        // Mostrar/ocultar secciones según configuración
        document.getElementById('stats-container').style.display = 
          configuracionInforme.mostrarEstadisticas ? 'grid' : 'none';
        document.getElementById('ranking-container').style.display = 
          configuracionInforme.mostrarRanking ? 'block' : 'none';
        document.getElementById('graficos-container').style.display = 
          configuracionInforme.mostrarGraficos ? 'block' : 'none';
        document.getElementById('detalle-container').style.display = 
          configuracionInforme.mostrarDetalle ? 'block' : 'none';

        // Actualizar contenido de cada sección
        if (configuracionInforme.mostrarEstadisticas) {
          actualizarEstadisticas(datosProcesados);
        }
        
        if (configuracionInforme.mostrarRanking) {
          actualizarRanking(datosProcesados);
        }
        
        if (configuracionInforme.mostrarGraficos) {
          actualizarGraficos(datosProcesados);
        }
        
        if (configuracionInforme.mostrarDetalle) {
          actualizarTablaDetalle(datosProcesados);
        }
      }

      // Función para actualizar estadísticas
      function actualizarEstadisticas(datos) {
        const statsContainer = document.getElementById('stats-container');
        
        if (!datos || datos.length === 0) {
          statsContainer.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron datos</p>';
          return;
        }

        // Calcular estadísticas
        const totalRepuestos = datos.length;
        const totalUnidades = datos.reduce((sum, item) => sum + item.unidades, 0);
        const totalValor = datos.reduce((sum, item) => sum + item.valor, 0);
        const promedioUnidades = totalRepuestos > 0 ? (totalUnidades / totalRepuestos).toFixed(2) : 0;
        const promedioValor = totalRepuestos > 0 ? (totalValor / totalRepuestos).toFixed(2) : 0;

        // Crear HTML de estadísticas
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalRepuestos}</div>
            <div class="stat-label">Repuestos Diferentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalUnidades}</div>
            <div class="stat-label">Total Unidades</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${totalValor.toLocaleString('es-CL')}</div>
            <div class="stat-label">Valor Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${promedioUnidades}</div>
            <div class="stat-label">Promedio Unidades</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${promedioValor}</div>
            <div class="stat-label">Promedio Valor</div>
          </div>
        `;
      }

      // Función para actualizar ranking
      function actualizarRanking(datos) {
        const rankingContainer = document.getElementById('ranking-cards-container');
        rankingContainer.innerHTML = '';

        if (datos.length === 0) {
          rankingContainer.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron datos</p>';
          return;
        }

        // Tomar los primeros 15 elementos para el ranking
        const topRepuestos = datos.slice(0, 15);

        // Crear HTML del ranking
        topRepuestos.forEach((item, index) => {
          const rankingItem = document.createElement('div');
          rankingItem.className = 'ranking-item';
          
          rankingItem.innerHTML = `
            <div class="ranking-position ${index < 3 ? 'top-' + (index + 1) : ''}">${index + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${item.nombre || 'Sin nombre'}</div>
              <div class="ranking-details">
                <span>${item.unidades} unidades</span>
                <span>$${item.valor.toLocaleString('es-CL')}</span>
              </div>
            </div>
          `;
          
          rankingContainer.appendChild(rankingItem);
        });
      }

      // Función para actualizar tabla de detalle
      function actualizarTablaDetalle(datos) {
        const tbody = document.getElementById('tabla-detalle').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (datos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron datos</td></tr>';
          return;
        }

        datos.forEach((item, index) => {
          const row = tbody.insertRow();
          
          // Posición
          const posicionCell = row.insertCell(0);
          posicionCell.textContent = index + 1;
          
          // Código
          const codigoCell = row.insertCell(1);
          codigoCell.textContent = item.codigo || '-';
          
          // Producto
          const productoCell = row.insertCell(2);
          productoCell.textContent = item.nombre || '-';
          
          // Unidades
          const unidadesCell = row.insertCell(3);
          unidadesCell.textContent = item.unidades || '0';
          
          // Valor Total
          const valorCell = row.insertCell(4);
          valorCell.textContent = '$' + (item.valor || 0).toLocaleString('es-CL');
          
          // Frecuencia
          const frecuenciaCell = row.insertCell(5);
          frecuenciaCell.textContent = item.frecuencia || '0';
          
          // Última Fecha
          const fechaCell = row.insertCell(6);
          fechaCell.textContent = item.ultimaFecha || '-';
          
          // Máquinas
          const maquinasCell = row.insertCell(7);
          maquinasCell.textContent = item.maquinas ? item.maquinas.join(', ') : '-';
        });
      }

      // Función para actualizar gráficos
      function actualizarGraficos(datos) {
        // Preparar datos para gráficos
        const datosGraficoUnidades = prepararDatosTopUnidades(datos);
        const datosGraficoValor = prepararDatosTopValor(datos);
        const datosGraficoFrecuencia = prepararDatosDistribucionFrecuencia(datos);
        const datosGraficoEvolucion = prepararDatosEvolucionRepuestos(datos);

        // Crear o actualizar gráficos
        crearGraficoTopUnidades(datosGraficoUnidades);
        crearGraficoTopValor(datosGraficoValor);
        crearGraficoDistribucionFrecuencia(datosGraficoFrecuencia);
        crearGraficoEvolucionRepuestos(datosGraficoEvolucion);
      }

      // Preparar datos para gráfico de top por unidades
      function prepararDatosTopUnidades(datos) {
        // Tomar los primeros 10 elementos
        const top10 = datos.slice(0, 10);
        
        return {
          labels: top10.map(item => item.nombre || item.codigo),
          datos: top10.map(item => item.unidades)
        };
      }

      // Preparar datos para gráfico de top por valor
      function prepararDatosTopValor(datos) {
        // Ordenar por valor y tomar los primeros 10
        const top10Valor = [...datos]
          .sort((a, b) => b.valor - a.valor)
          .slice(0, 10);
        
        return {
          labels: top10Valor.map(item => item.nombre || item.codigo),
          datos: top10Valor.map(item => item.valor)
        };
      }

      // Preparar datos para gráfico de distribución por frecuencia
      function prepararDatosDistribucionFrecuencia(datos) {
        // Agrupar por rangos de frecuencia
        const rangos = {
          '1 vez': 0,
          '2-5 veces': 0,
          '6-10 veces': 0,
          '11-20 veces': 0,
          'Más de 20 veces': 0
        };
        
        datos.forEach(item => {
          if (item.frecuencia === 1) {
            rangos['1 vez']++;
          } else if (item.frecuencia >= 2 && item.frecuencia <= 5) {
            rangos['2-5 veces']++;
          } else if (item.frecuencia >= 6 && item.frecuencia <= 10) {
            rangos['6-10 veces']++;
          } else if (item.frecuencia >= 11 && item.frecuencia <= 20) {
            rangos['11-20 veces']++;
          } else {
            rangos['Más de 20 veces']++;
          }
        });
        
        return {
          labels: Object.keys(rangos),
          datos: Object.values(rangos)
        };
      }

      // Preparar datos para gráfico de evolución de repuestos
      function prepararDatosEvolucionRepuestos(datos) {
        // Tomar los 5 repuestos más utilizados
        const top5 = datos.slice(0, 5);
        
        // En una implementación real, aquí se obtendrían datos históricos
        // Por ahora, simulamos datos de evolución
        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        const datasets = top5.map((item, index) => {
          // Generar datos aleatorios para simular evolución
          const datosEvolucion = meses.map(() => Math.floor(Math.random() * 100) + 10);
          
          return {
            label: item.nombre || item.codigo,
            data: datosEvolucion,
            borderColor: getColorByIndex(index),
            backgroundColor: getColorByIndex(index, 0.1),
            borderWidth: 2,
            tension: 0.3
          };
        });
        
        return {
          labels: meses,
          datasets: datasets
        };
      }

      // Función auxiliar para obtener colores por índice
      function getColorByIndex(index, alpha = 1) {
        const colors = [
          `rgba(63, 114, 175, ${alpha})`,
          `rgba(231, 76, 60, ${alpha})`,
          `rgba(46, 204, 113, ${alpha})`,
          `rgba(243, 156, 18, ${alpha})`,
          `rgba(155, 89, 182, ${alpha})`
        ];
        return colors[index % colors.length];
      }

      // Crear gráfico de top por unidades
      function crearGraficoTopUnidades(datos) {
        const ctx = document.getElementById('chart-top-unidades').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.topUnidades) {
          charts.topUnidades.destroy();
        }
        
        charts.topUnidades = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Unidades',
              data: datos.datos,
              backgroundColor: 'rgba(63, 114, 175, 0.7)',
              borderColor: 'rgba(63, 114, 175, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Unidades'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      // Crear gráfico de top por valor
      function crearGraficoTopValor(datos) {
        const ctx = document.getElementById('chart-top-valor').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.topValor) {
          charts.topValor.destroy();
        }
        
        charts.topValor = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Valor ($)',
              data: datos.datos,
              backgroundColor: 'rgba(231, 76, 60, 0.7)',
              borderColor: 'rgba(231, 76, 60, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Valor ($)'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      // Crear gráfico de distribución por frecuencia
      function crearGraficoDistribucionFrecuencia(datos) {
        const ctx = document.getElementById('chart-distribucion-frecuencia').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.distribucionFrecuencia) {
          charts.distribucionFrecuencia.destroy();
        }
        
        charts.distribucionFrecuencia = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: datos.labels,
            datasets: [{
              data: datos.datos,
              backgroundColor: [
                'rgba(63, 114, 175, 0.7)',
                'rgba(219, 226, 239, 0.7)',
                'rgba(44, 82, 130, 0.7)',
                'rgba(17, 45, 78, 0.7)',
                'rgba(46, 204, 113, 0.7)'
              ],
              borderColor: [
                'rgba(63, 114, 175, 1)',
                'rgba(219, 226, 239, 1)',
                'rgba(44, 82, 130, 1)',
                'rgba(17, 45, 78, 1)',
                'rgba(46, 204, 113, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              }
            }
          }
        });
      }

      // Crear gráfico de evolución de repuestos
      function crearGraficoEvolucionRepuestos(datos) {
        const ctx = document.getElementById('chart-evolucion-repuestos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.evolucionRepuestos) {
          charts.evolucionRepuestos.destroy();
        }
        
        charts.evolucionRepuestos = new Chart(ctx, {
          type: 'line',
          data: datos,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Unidades'
                }
              }
            }
          }
        });
      }

      // Función para manejar la selección de período
      function seleccionarPeriodo(periodo) {
        // Actualizar variable global
        periodoSeleccionado = periodo;
        
        // Actualizar estado visual de los botones
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Activar el botón seleccionado
        document.querySelector(`.periodo-btn[data-periodo="${periodo}"]`).classList.add('active');
        
        // Mostrar/ocultar campos de fecha según el período
        if (periodo === 'personalizado') {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'block';
          document.getElementById('fecha-fin-group').style.display = 'block';
        } else if (periodo === 'dia') {
          document.getElementById('fecha-personalizada-group').style.display = 'block';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        } else {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        }
      }

      // Función para mostrar modal de selección de datos
      function mostrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'flex';
        
        // Establecer valores actuales en los checkboxes
        document.getElementById('mostrar-estadisticas').checked = configuracionInforme.mostrarEstadisticas;
        document.getElementById('mostrar-ranking').checked = configuracionInforme.mostrarRanking;
        document.getElementById('mostrar-graficos').checked = configuracionInforme.mostrarGraficos;
        document.getElementById('mostrar-detalle').checked = configuracionInforme.mostrarDetalle;
      }

      // Función para cerrar modal de selección de datos
      function cerrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'none';
      }

      // Función para generar informe con la configuración seleccionada
      function generarInforme() {
        // Obtener configuración seleccionada
        configuracionInforme = {
          mostrarEstadisticas: document.getElementById('mostrar-estadisticas').checked,
          mostrarRanking: document.getElementById('mostrar-ranking').checked,
          mostrarGraficos: document.getElementById('mostrar-graficos').checked,
          mostrarDetalle: document.getElementById('mostrar-detalle').checked
        };

        // Cerrar modal
        cerrarModalSeleccionDatos();

        // Generar informe con la configuración seleccionada
        cargarDatosRepuestos();
        
        mostrarExito('Informe generado con éxito');
      }

      // Función para limpiar filtros
      function limpiarFiltros() {
        // Configurar período por defecto (mes)
        seleccionarPeriodo('mes');
        
        // Configurar fechas por defecto (último mes)
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setMonth(fechaInicio.getMonth() - 1);
        
        document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
        document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
        document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];
        
        document.getElementById('patente-filtro').value = '';
        document.getElementById('mostrar-top').value = '0';
        document.getElementById('ordenar-por').value = 'unidades';
        
        // Cargar datos sin filtros
        cargarDatosRepuestos();
      }

      // Mostrar mensaje de error
      function mostrarError(mensaje) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = mensaje;
        errorElement.style.display = 'block';

        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }

      // Mostrar mensaje de éxito
      function mostrarExito(mensaje) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = mensaje;
        successElement.style.display = 'block';

        setTimeout(() => {
          successElement.style.display = 'none';
        }, 3000);
      }

      // Inicializar la aplicación cuando se cargue la página
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar eventos para los botones de período
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-periodo');
            seleccionarPeriodo(periodo);
          });
        });

        // Configurar eventos para cambios en filtros
        document.getElementById('patente-filtro').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        document.getElementById('mostrar-top').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        document.getElementById('ordenar-por').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        await inicializarSupabase();
      });
    </script>
  </div>
</body>
</html>
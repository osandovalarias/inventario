<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Inventario - Repuestos por Máquina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #3f72af;
      --color-secondary: #dbe2ef;
      --color-text: #112d4e;
      --color-accent: #2c5282;
      --color-success: #2ecc71;
      --color-error: #e74c3c;
      --color-warning: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      --header-bg-color: #2c5282;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--color-text);
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background-color: var(--header-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    h2 {
      margin-top: 30px;
      font-size: 1.5rem;
    }

    h3 {
      text-align: left;
      color: var(--color-primary);
      border-bottom: none;
      padding-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: white;
      padding: 5px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .title-container {
      flex: 1;
    }

    .subtitle {
      text-align: center;
      color: #dbe2ef;
      margin-top: -10px;
      font-size: 1.1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--color-error);
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--color-primary);
    }

    .btn-info:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-print {
      background: #17a2b8;
    }

    .btn-print:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .status-message {
      padding: 15px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .success {
      background-color: #d4edda;
      color: var(--color-success);
      border-left: 4px solid var(--color-success);
    }

    .info {
      background-color: #e7f5ff;
      color: var(--color-primary);
      border-left: 4px solid var(--color-primary);
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .connection-success {
      background-color: var(--color-success);
      color: white;
    }

    .connection-error {
      background-color: var(--color-error);
      color: white;
    }

    .connection-loading {
      background-color: var(--color-primary);
      color: white;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .input-group input, 
    .input-group select, 
    .input-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .resultados-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
    }

    .tabla-resultados {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .tabla-resultados th {
      background-color: var(--color-primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .tabla-resultados td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tabla-resultados tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .tabla-resultados tr:hover {
      background-color: #f1f1f1;
    }

    /* Estilos para gráficos */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    /* Estilos para filtros */
    .filters-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* Estilos para selector de períodos */
    .periodo-selector-container {
      margin-bottom: 20px;
    }

    .periodo-selector-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .periodo-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .periodo-btn {
      padding: 10px 20px;
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
      flex: 1;
      min-width: 120px;
      max-width: 150px;
    }

    .periodo-btn.active {
      background-color: var(--color-primary);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .periodo-btn:hover:not(.active) {
      background-color: var(--color-secondary);
    }

    /* Estilos para estadísticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para tarjetas de productos */
    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .producto-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .producto-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .producto-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .producto-nombre {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .producto-ranking {
      background-color: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .producto-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .producto-stat {
      text-align: center;
    }

    .producto-stat-value {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .producto-stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .producto-progress {
      background-color: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .producto-progress-bar {
      height: 100%;
      background-color: white;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .producto-percentage {
      text-align: right;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Estilos para comparación */
    .comparison-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .comparison-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
      font-size: 1.2rem;
    }

    .comparison-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .comparison-item:last-child {
      border-bottom: none;
    }

    .comparison-label {
      font-weight: 600;
    }

    .comparison-value {
      font-weight: bold;
    }

    /* Estilos para tabla de ranking */
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .ranking-table th {
      background-color: var(--color-primary);
      color: white;
      padding: 12px;
      text-align: center;
    }

    .ranking-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    .ranking-table .ranking-cell {
      width: 50px;
      text-align: center;
    }

    .ranking-table .top-1 {
      background-color: #FFD700;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .ranking-table .top-2 {
      background-color: #C0C0C0;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .ranking-table .top-3 {
      background-color: #CD7F32;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    /* Estilos para modal de selección de datos */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .modal-title {
      color: var(--color-primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .close-modal:hover {
      color: var(--color-error);
    }

    .data-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .data-selection-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .data-selection-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .data-selection-item label {
      font-weight: normal;
      margin-bottom: 0;
    }

    /* Estilos para tabla de detalle */
    .detalle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    .detalle-title {
      color: var(--color-primary);
      margin: 0;
    }

    .detalle-filtro {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--color-text);
    }

    /* Estilos para indicadores de tendencia */
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .trend-up {
      color: var(--color-success);
    }

    .trend-down {
      color: var(--color-error);
    }

    .trend-neutral {
      color: #666;
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .header-container {
        background-color: white !important;
        color: black !important;
        box-shadow: none;
        border: 1px solid #ddd;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .btn, .btn-group {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
      }

      .subtitle {
        color: #555 !important;
      }

      .productos-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-wrapper {
        height: 300px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .productos-grid {
        grid-template-columns: 1fr;
      }
      
      .comparison-container {
        grid-template-columns: 1fr;
      }
      
      .producto-stats {
        grid-template-columns: 1fr;
      }
      
      .data-selection-grid {
        grid-template-columns: 1fr;
      }
      
      .periodo-selector {
        flex-direction: column;
      }
      
      .periodo-btn {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container">
        <div class="logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div>
          <h1>Control de Inventario</h1>
          <div class="subtitle">Reporte de Repuestos por Máquina</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-print" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>

    <div id="error-message" class="status-message error" style="display: none;"></div>
    <div id="success-message" class="status-message success" style="display: none;"></div>

    <div class="filters-container">
      <h3>Configuración del Informe</h3>
      
      <!-- Selector de períodos como etiquetas -->
      <div class="periodo-selector-container">
        <label class="periodo-selector-label">Seleccione el período:</label>
        <div class="periodo-selector">
          <div class="periodo-btn active" data-periodo="dia">Día</div>
          <div class="periodo-btn" data-periodo="semana">Semana</div>
          <div class="periodo-btn" data-periodo="mes">Mes</div>
          <div class="periodo-btn" data-periodo="bimestre">Bimestre</div>
          <div class="periodo-btn" data-periodo="trimestre">Trimestre</div>
          <div class="periodo-btn" data-periodo="cuatrimestre">Cuatrimestre</div>
          <div class="periodo-btn" data-periodo="semestre">Semestre</div>
          <div class="periodo-btn" data-periodo="anio">Año</div>
          <div class="periodo-btn" data-periodo="personalizado">Personalizado</div>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group" id="fecha-personalizada-group" style="display: none;">
          <label for="fecha-personalizada">Fecha:</label>
          <input type="date" id="fecha-personalizada">
        </div>
        <div class="filter-group" id="fecha-inicio-group" style="display: none;">
          <label for="fecha-inicio">Fecha de Inicio:</label>
          <input type="date" id="fecha-inicio">
        </div>
        <div class="filter-group" id="fecha-fin-group" style="display: none;">
          <label for="fecha-fin">Fecha de Fin:</label>
          <input type="date" id="fecha-fin">
        </div>
        <div class="filter-group">
          <label for="tipo-analisis">Tipo de Análisis:</label>
          <select id="tipo-analisis">
            <option value="general">Vista General</option>
            <option value="detallado">Vista Detallada</option>
            <option value="comparativo">Análisis Comparativo</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label for="patente-filtro">Máquina:</label>
          <select id="patente-filtro">
            <option value="">Todas las máquinas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="ordenar-por">Ordenar por:</label>
          <select id="ordenar-por">
            <option value="unidades">Unidades Utilizadas</option>
            <option value="gastos">Valor Total</option>
            <option value="frecuencia">Frecuencia de Uso</option>
            <option value="maquinas">Cantidad de Máquinas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="mostrar-top">Mostrar:</label>
          <select id="mostrar-top">
            <option value="0">Todos los repuestos</option>
            <option value="5">Top 5</option>
            <option value="10">Top 10</option>
            <option value="15">Top 15</option>
            <option value="20">Top 20</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
        <button class="btn btn-primary" onclick="mostrarModalSeleccionDatos()">
          <i class="fas fa-file-alt"></i> Generar Informe
        </button>
      </div>
    </div>

    <!-- Modal para selección de datos -->
    <div id="modal-seleccion-datos" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Seleccionar Datos para el Informe</h3>
          <button class="close-modal" onclick="cerrarModalSeleccionDatos()">&times;</button>
        </div>
        <p>Seleccione qué elementos desea incluir en el informe:</p>
        
        <div class="data-selection-grid">
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-estadisticas" checked>
            <label for="mostrar-estadisticas">Estadísticas Generales</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-tarjetas" checked>
            <label for="mostrar-tarjetas">Tarjetas de Productos</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-ranking" checked>
            <label for="mostrar-ranking">Ranking de Productos</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-graficos" checked>
            <label for="mostrar-graficos">Gráficos de Análisis</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-comparacion" checked>
            <label for="mostrar-comparacion">Análisis Comparativo</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-detalle" checked>
            <label for="mostrar-detalle">Detalle de Uso</label>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cerrarModalSeleccionDatos()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-success" onclick="generarInforme()">
            <i class="fas fa-check"></i> Generar Informe
          </button>
        </div>
      </div>
    </div>

    <div class="stats-container" id="stats-container">
      <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

    <div class="resultados-container" id="tarjetas-container">
      <h3>Productos Más Utilizados</h3>
      <div class="productos-grid" id="productos-grid">
        <!-- Las tarjetas de productos se cargarán dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="ranking-container">
      <h3>Ranking de Productos por Uso</h3>
      <table class="ranking-table" id="tabla-ranking">
        <thead>
          <tr>
            <th>Posición</th>
            <th>Producto</th>
            <th>Código</th>
            <th>Unidades</th>
            <th>Valor Total</th>
            <th>Máquinas</th>
            <th>Frecuencia</th>
            <th>% del Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div class="resultados-container" id="graficos-container">
      <h3>Análisis Gráfico de Repuestos</h3>
      <div class="charts-container">
        <div class="chart-card">
          <h4 class="chart-title">Productos Más Utilizados</h4>
          <div class="chart-wrapper">
            <canvas id="chart-repuestos-mas-usados"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Repuestos por Máquina</h4>
          <div class="chart-wrapper">
            <canvas id="chart-repuestos-por-maquina"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Evolución Mensual</h4>
          <div class="chart-wrapper">
            <canvas id="chart-evolucion-mensual"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Distribución por Concepto</h4>
          <div class="chart-wrapper">
            <canvas id="chart-distribucion-concepto"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="resultados-container" id="comparacion-container">
      <h3>Análisis Comparativo</h3>
      <div class="comparison-container" id="comparison-container">
        <!-- La comparación se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="detalle-container" style="display: none;">
      <div class="detalle-header">
        <h3 class="detalle-title">Detalle de Uso</h3>
        <div class="detalle-filtro" id="detalle-filtro"></div>
      </div>
      <table class="tabla-resultados" id="tabla-detalle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Máquina</th>
            <th>Producto</th>
            <th>Código</th>
            <th>Unidades</th>
            <th>Valor Unitario</th>
            <th>Valor Total</th>
            <th>Concepto</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div id="connection-status" class="connection-status connection-loading" style="display: none;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a la base de datos...
    </div>

    <script>
      // Variables globales
      let supabaseClient;
      let maquinasBase = [];
      let productosBase = [];
      let datosCompletos = null;
      let datosProductos = null;
      let productoSeleccionado = null;
      let charts = {};
      let configuracionInforme = {
        mostrarEstadisticas: true,
        mostrarTarjetas: true,
        mostrarRanking: true,
        mostrarGraficos: true,
        mostrarComparacion: true,
        mostrarDetalle: true
      };
      let periodoSeleccionado = 'mes'; // Período por defecto

      // Función para inicializar Supabase
      async function inicializarSupabase() {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.style.display = 'block';

        try {
          // Configuración de Supabase - Reemplaza con tus credenciales
          const supabaseUrl = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';

          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

          // Verificar conexión obteniendo datos necesarios
          const [maquinas, productos] = await Promise.all([
            obtenerMaquinas(),
            obtenerProductosCatalogo()
          ]);

          connectionStatus.className = 'connection-status connection-success';
          connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a la base de datos';

          setTimeout(() => {
            connectionStatus.style.display = 'none';
          }, 3000);

          // Actualizar lista de máquinas
          if (maquinas && maquinas.length > 0) {
            maquinasBase = maquinas;
            const selectPatente = document.getElementById('patente-filtro');
            maquinas.forEach(maquina => {
              const option = document.createElement('option');
              option.value = maquina.patente;
              option.textContent = maquina.patente;
              selectPatente.appendChild(option);
            });
          }

          // Actualizar lista de productos
          if (productos && productos.length > 0) {
            productosBase = productos;
          }

          // Configurar fechas por defecto (último mes)
          const fechaFin = new Date();
          const fechaInicio = new Date();
          fechaInicio.setMonth(fechaInicio.getMonth() - 1);
          
          document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
          document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
          document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];

          // Cargar datos iniciales
          await cargarDatosRepuestos();

          return true;
        } catch (error) {
          console.error('Error al conectar con Supabase:', error);
          connectionStatus.className = 'connection-status connection-error';
          connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
          mostrarError(`Error al conectar con la base de datos: ${error.message}`);
          return false;
        }
      }

      // Función para obtener máquinas
      async function obtenerMaquinas() {
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('patente')
          .order('patente', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener productos del catálogo
      async function obtenerProductosCatalogo() {
        const { data, error } = await supabaseClient
          .from('productos')
          .select('id, codigo, nombre_producto')
          .order('id', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener datos de repuestos por máquina
      async function obtenerDatosRepuestos(fechaInicio, fechaFin) {
        let query = supabaseClient
          .from('registros')
          .select('*')
          .eq('estado', 'salida')
          .gte('fecha', fechaInicio)
          .lte('fecha', fechaFin)
          .order('fecha', { ascending: false });

        const { data, error } = await query;

        if (error) throw error;
        return data;
      }

      // Función para calcular fechas según período seleccionado
      function calcularFechasPorPeriodo(periodo) {
        const fechaFin = new Date();
        let fechaInicio = new Date();
        
        switch(periodo) {
          case 'dia':
            fechaInicio.setDate(fechaFin.getDate() - 1);
            break;
          case 'semana':
            fechaInicio.setDate(fechaFin.getDate() - 7);
            break;
          case 'mes':
            fechaInicio.setMonth(fechaFin.getMonth() - 1);
            break;
          case 'bimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 2);
            break;
          case 'trimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 3);
            break;
          case 'cuatrimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 4);
            break;
          case 'semestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 6);
            break;
          case 'anio':
            fechaInicio.setFullYear(fechaFin.getFullYear() - 1);
            break;
          case 'personalizado':
            // Para personalizado, usamos las fechas del formulario
            const fechaInicioInput = document.getElementById('fecha-inicio').value;
            const fechaFinInput = document.getElementById('fecha-fin').value;
            
            if (fechaInicioInput && fechaFinInput) {
              fechaInicio = new Date(fechaInicioInput);
              fechaFin = new Date(fechaFinInput);
            } else {
              // Por defecto, último mes
              fechaInicio.setMonth(fechaFin.getMonth() - 1);
            }
            break;
        }
        
        return {
          fechaInicio: fechaInicio.toISOString().split('T')[0],
          fechaFin: fechaFin.toISOString().split('T')[0]
        };
      }

      // Función para procesar datos por producto
      function procesarDatosPorProducto(datos) {
        const productosAgrupados = {};
        let unidadesTotalGlobal = 0;
        let valorTotalGlobal = 0;
        
        // Procesar cada movimiento
        datos.forEach(item => {
          const clave = `${item.codigo} - ${item.nombre}`;
          
          if (!productosAgrupados[clave]) {
            productosAgrupados[clave] = {
              codigo: item.codigo,
              nombre: item.nombre,
              movimientos: 0,
              unidades: 0,
              valorTotal: 0,
              maquinas: new Set(),
              conceptos: {},
              fechas: [],
              detalles: []
            };
          }
          
          const producto = productosAgrupados[clave];
          producto.movimientos++;
          producto.unidades += item.unidades || 0;
          producto.valorTotal += item.precio_total || 0;
          producto.maquinas.add(item.patente);
          producto.fechas.push(item.fecha);
          producto.detalles.push(item);
          
          // Agrupar por concepto
          const concepto = item.concepto || 'Sin concepto';
          if (!producto.conceptos[concepto]) {
            producto.conceptos[concepto] = 0;
          }
          producto.conceptos[concepto] += item.precio_total || 0;
          
          unidadesTotalGlobal += item.unidades || 0;
          valorTotalGlobal += item.precio_total || 0;
        });

        // Calcular porcentajes y promedios
        Object.values(productosAgrupados).forEach(producto => {
          producto.porcentajeUnidades = unidadesTotalGlobal > 0 ? (producto.unidades / unidadesTotalGlobal) * 100 : 0;
          producto.porcentajeValor = valorTotalGlobal > 0 ? (producto.valorTotal / valorTotalGlobal) * 100 : 0;
          producto.numMaquinas = producto.maquinas.size;
          producto.valorPromedio = producto.movimientos > 0 ? producto.valorTotal / producto.movimientos : 0;
          producto.ultimaFecha = producto.fechas.length > 0 ? 
            new Date(Math.max(...producto.fechas.map(f => new Date(f)))) : null;
        });

        return {
          productos: productosAgrupados,
          unidadesTotalGlobal: unidadesTotalGlobal,
          valorTotalGlobal: valorTotalGlobal,
          totalMovimientos: datos.length
        };
      }

      // Función para cargar datos de repuestos
      async function cargarDatosRepuestos() {
        try {
          // Obtener valores de filtros
          const patente = document.getElementById('patente-filtro').value;
          const ordenarPor = document.getElementById('ordenar-por').value;
          const mostrarTop = parseInt(document.getElementById('mostrar-top').value);

          // Calcular fechas según período
          const fechas = calcularFechasPorPeriodo(periodoSeleccionado);

          // Obtener datos
          let datos = await obtenerDatosRepuestos(fechas.fechaInicio, fechas.fechaFin);
          datosCompletos = datos;
          
          // Filtrar por patente si es necesario
          if (patente) {
            datos = datos.filter(item => item.patente === patente);
          }
          
          // Procesar datos por producto
          const resultado = procesarDatosPorProducto(datos);
          datosProductos = resultado.productos;

          // Ordenar productos
          let productosOrdenados = Object.values(datosProductos);
          
          switch(ordenarPor) {
            case 'unidades':
              productosOrdenados.sort((a, b) => b.unidades - a.unidades);
              break;
            case 'gastos':
              productosOrdenados.sort((a, b) => b.valorTotal - a.valorTotal);
              break;
            case 'frecuencia':
              productosOrdenados.sort((a, b) => b.movimientos - a.movimientos);
              break;
            case 'maquinas':
              productosOrdenados.sort((a, b) => b.numMaquinas - a.numMaquinas);
              break;
          }

          // Aplicar filtro de top si es necesario
          if (mostrarTop > 0) {
            productosOrdenados = productosOrdenados.slice(0, mostrarTop);
          }

          // Actualizar interfaz según configuración
          actualizarVistaInforme(productosOrdenados, resultado);

        } catch (error) {
          console.error('Error al cargar datos de repuestos:', error);
          mostrarError('Error al cargar datos: ' + error.message);
        }
      }

      // Función para actualizar la vista según la configuración del informe
      function actualizarVistaInforme(productosOrdenados, resultado) {
        // Mostrar/ocultar secciones según configuración
        document.getElementById('stats-container').style.display = 
          configuracionInforme.mostrarEstadisticas ? 'grid' : 'none';
        document.getElementById('tarjetas-container').style.display = 
          configuracionInforme.mostrarTarjetas ? 'block' : 'none';
        document.getElementById('ranking-container').style.display = 
          configuracionInforme.mostrarRanking ? 'block' : 'none';
        document.getElementById('graficos-container').style.display = 
          configuracionInforme.mostrarGraficos ? 'block' : 'none';
        document.getElementById('comparacion-container').style.display = 
          configuracionInforme.mostrarComparacion ? 'block' : 'none';
        document.getElementById('detalle-container').style.display = 
          configuracionInforme.mostrarDetalle && productoSeleccionado ? 'block' : 'none';

        // Actualizar contenido de cada sección
        if (configuracionInforme.mostrarEstadisticas) {
          actualizarEstadisticas(resultado);
        }
        
        if (configuracionInforme.mostrarTarjetas) {
          actualizarTarjetasProductos(productosOrdenados, resultado.unidadesTotalGlobal, resultado.valorTotalGlobal);
        }
        
        if (configuracionInforme.mostrarRanking) {
          actualizarTablaRanking(productosOrdenados, resultado.unidadesTotalGlobal, resultado.valorTotalGlobal);
        }
        
        if (configuracionInforme.mostrarGraficos) {
          actualizarGraficos(productosOrdenados, resultado);
        }
        
        if (configuracionInforme.mostrarComparacion) {
          actualizarComparacion(productosOrdenados);
        }
      }

      // Función para actualizar estadísticas
      function actualizarEstadisticas(resultado) {
        const statsContainer = document.getElementById('stats-container');

        if (!resultado || Object.keys(resultado.productos).length === 0) {
          statsContainer.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron datos</p>';
          return;
        }

        const totalProductos = Object.keys(resultado.productos).length;
        const promedioUnidades = resultado.unidadesTotalGlobal / totalProductos;
        const promedioValor = resultado.valorTotalGlobal / totalProductos;
        const productoMasUsado = Object.values(resultado.productos).reduce((max, producto) => 
          producto.unidades > max.unidades ? producto : max, {unidades: 0});

        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalProductos}</div>
            <div class="stat-label">Productos Diferentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${resultado.unidadesTotalGlobal.toLocaleString('es-CL')}</div>
            <div class="stat-label">Total Unidades</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${resultado.valorTotalGlobal.toLocaleString('es-CL')}</div>
            <div class="stat-label">Valor Total</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${resultado.totalMovimientos}</div>
            <div class="stat-label">Total Movimientos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${productoMasUsado.nombre?.substring(0, 10) || 'N/A'}</div>
            <div class="stat-label">Producto Más Usado</div>
          </div>
        `;
      }

      // Función para actualizar tarjetas de productos
      function actualizarTarjetasProductos(productos, unidadesTotalGlobal, valorTotalGlobal) {
        const productosGrid = document.getElementById('productos-grid');
        productosGrid.innerHTML = '';

        if (productos.length === 0) {
          productosGrid.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron productos</p>';
          return;
        }

        productos.forEach((producto, index) => {
          const card = document.createElement('div');
          card.className = 'producto-card';
          card.style.background = getGradientByIndex(index);
          card.onclick = () => mostrarDetalleProducto(producto.codigo, producto.nombre);

          const porcentajeUnidades = (producto.unidades / unidadesTotalGlobal) * 100;
          const porcentajeValor = (producto.valorTotal / valorTotalGlobal) * 100;
          const ranking = index + 1;

          card.innerHTML = `
            <div class="producto-header">
              <div class="producto-nombre">${producto.nombre.substring(0, 20)}${producto.nombre.length > 20 ? '...' : ''}</div>
              <div class="producto-ranking">#${ranking}</div>
            </div>
            <div class="producto-stats">
              <div class="producto-stat">
                <div class="producto-stat-value">${producto.unidades.toLocaleString('es-CL')}</div>
                <div class="producto-stat-label">Unidades</div>
              </div>
              <div class="producto-stat">
                <div class="producto-stat-value">$${producto.valorTotal.toLocaleString('es-CL')}</div>
                <div class="producto-stat-label">Valor Total</div>
              </div>
            </div>
            <div class="producto-progress">
              <div class="producto-progress-bar" style="width: ${Math.min(porcentajeUnidades, 100)}%"></div>
            </div>
            <div class="producto-percentage">
              ${porcentajeUnidades.toFixed(1)}% unidades | ${porcentajeValor.toFixed(1)}% valor
            </div>
          `;

          productosGrid.appendChild(card);
        });
      }

      // Función para actualizar tabla de ranking
      function actualizarTablaRanking(productos, unidadesTotalGlobal, valorTotalGlobal) {
        const tbody = document.getElementById('tabla-ranking').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (productos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron datos</td></tr>';
          return;
        }

        productos.forEach((producto, index) => {
          const row = tbody.insertRow();
          const ranking = index + 1;
          
          // Posición
          const posicionCell = row.insertCell(0);
          if (ranking <= 3) {
            posicionCell.innerHTML = `<div class="top-${ranking}">${ranking}</div>`;
          } else {
            posicionCell.textContent = ranking;
          }
          
          // Producto
          const productoCell = row.insertCell(1);
          productoCell.textContent = producto.nombre;
          
          // Código
          const codigoCell = row.insertCell(2);
          codigoCell.textContent = producto.codigo;
          
          // Unidades
          const unidadesCell = row.insertCell(3);
          unidadesCell.textContent = producto.unidades.toLocaleString('es-CL');
          
          // Valor Total
          const valorCell = row.insertCell(4);
          valorCell.textContent = `$${producto.valorTotal.toLocaleString('es-CL')}`;
          
          // Máquinas
          const maquinasCell = row.insertCell(5);
          maquinasCell.textContent = producto.numMaquinas;
          
          // Frecuencia
          const frecuenciaCell = row.insertCell(6);
          frecuenciaCell.textContent = producto.movimientos;
          
          // Porcentaje del Total (unidades)
          const porcentajeCell = row.insertCell(7);
          const porcentaje = (producto.unidades / unidadesTotalGlobal) * 100;
          porcentajeCell.textContent = `${porcentaje.toFixed(1)}%`;
        });
      }

      // Función para actualizar comparación
      function actualizarComparacion(productos) {
        const comparisonContainer = document.getElementById('comparison-container');

        if (productos.length === 0) {
          comparisonContainer.innerHTML = '<p style="text-align: center; width: 100%;">No hay datos para comparar</p>';
          return;
        }

        // Tomar las 3 productos con más unidades para comparación
        const topProductos = productos.slice(0, 3);
        const totalUnidades = topProductos.reduce((sum, p) => sum + p.unidades, 0);

        comparisonContainer.innerHTML = topProductos.map(producto => {
          const porcentaje = (producto.unidades / totalUnidades) * 100;
          const conceptos = Object.keys(producto.conceptos).slice(0, 2); // Top 2 conceptos
          
          return `
            <div class="comparison-card">
              <h4 class="comparison-title">${producto.nombre.substring(0, 20)}${producto.nombre.length > 20 ? '...' : ''}</h4>
              <div class="comparison-item">
                <span class="comparison-label">Unidades:</span>
                <span class="comparison-value">${producto.unidades.toLocaleString('es-CL')}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Valor Total:</span>
                <span class="comparison-value">$${producto.valorTotal.toLocaleString('es-CL')}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Porcentaje:</span>
                <span class="comparison-value">${porcentaje.toFixed(1)}%</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Máquinas:</span>
                <span class="comparison-value">${producto.numMaquinas}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Conceptos:</span>
                <span class="comparison-value">${conceptos.join(', ')}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Función para mostrar detalle de producto
      function mostrarDetalleProducto(codigo, nombre) {
        if (!configuracionInforme.mostrarDetalle) return;
        
        productoSeleccionado = codigo;
        const producto = datosProductos[`${codigo} - ${nombre}`];
        
        if (!producto) return;

        // Actualizar header del detalle
        document.getElementById('detalle-filtro').textContent = `${nombre} (${codigo})`;
        
        // Actualizar tabla de detalle
        const tbody = document.getElementById('tabla-detalle').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        producto.detalles.forEach(item => {
          const row = tbody.insertRow();
          
          // Fecha
          const fechaCell = row.insertCell(0);
          fechaCell.textContent = item.fecha || '-';
          
          // Máquina
          const maquinaCell = row.insertCell(1);
          maquinaCell.textContent = item.patente || '-';
          
          // Producto
          const productoCell = row.insertCell(2);
          productoCell.textContent = item.nombre || '-';
          
          // Código
          const codigoCell = row.insertCell(3);
          codigoCell.textContent = item.codigo || '-';
          
          // Unidades
          const unidadesCell = row.insertCell(4);
          unidadesCell.textContent = item.unidades || '0';
          
          // Valor Unitario
          const valorUnitarioCell = row.insertCell(5);
          const precioUnitario = item.unidades > 0 ? (item.precio_total || 0) / item.unidades : 0;
          valorUnitarioCell.textContent = `$${precioUnitario.toLocaleString('es-CL', {maximumFractionDigits: 2})}`;
          
          // Valor Total
          const valorTotalCell = row.insertCell(6);
          valorTotalCell.textContent = `$${(item.precio_total || 0).toLocaleString('es-CL')}`;
          
          // Concepto
          const conceptoCell = row.insertCell(7);
          conceptoCell.textContent = item.concepto || '-';
        });

        // Mostrar contenedor de detalle
        document.getElementById('detalle-container').style.display = 'block';
        
        // Scroll al detalle
        document.getElementById('detalle-container').scrollIntoView({ 
          behavior: 'smooth' 
        });
      }

      // Función para actualizar gráficos
      function actualizarGraficos(productos, resultado) {
        // Preparar datos para gráficos
        const datosGraficoRepuestos = prepararDatosRepuestosMasUsados(productos);
        const datosGraficoMaquinas = prepararDatosRepuestosPorMaquina(productos);
        const datosGraficoEvolucion = prepararDatosEvolucionMensual(datosCompletos);
        const datosGraficoConcepto = prepararDatosDistribucionConcepto(datosCompletos);

        // Crear o actualizar gráficos
        crearGraficoRepuestosMasUsados(datosGraficoRepuestos);
        crearGraficoRepuestosPorMaquina(datosGraficoMaquinas);
        crearGraficoEvolucionMensual(datosGraficoEvolucion);
        crearGraficoDistribucionConcepto(datosGraficoConcepto);
      }

      // Preparar datos para gráfico de repuestos más usados
      function prepararDatosRepuestosMasUsados(productos) {
        return {
          labels: productos.map(p => p.nombre.substring(0, 20) + (p.nombre.length > 20 ? '...' : '')),
          datos: productos.map(p => p.unidades),
          valores: productos.map(p => p.valorTotal)
        };
      }

      // Preparar datos para gráfico de repuestos por máquina
      function prepararDatosRepuestosPorMaquina(productos) {
        // Para este gráfico, necesitamos los datos completos
        const maquinasAgrupadas = {};
        
        if (datosCompletos) {
          datosCompletos.forEach(item => {
            const patente = item.patente || 'Sin patente';
            if (!maquinasAgrupadas[patente]) {
              maquinasAgrupadas[patente] = {
                unidades: 0,
                valor: 0
              };
            }
            maquinasAgrupadas[patente].unidades += item.unidades || 0;
            maquinasAgrupadas[patente].valor += item.precio_total || 0;
          });
        }

        return {
          labels: Object.keys(maquinasAgrupadas),
          datos: Object.values(maquinasAgrupadas).map(item => item.unidades),
          valores: Object.values(maquinasAgrupadas).map(item => item.valor)
        };
      }

      // Preparar datos para gráfico de evolución mensual
      function prepararDatosEvolucionMensual(datos) {
        const mesesAgrupados = {};
        
        datos.forEach(item => {
          if (item.fecha) {
            const fecha = new Date(item.fecha);
            const mesAnio = `${fecha.getMonth() + 1}/${fecha.getFullYear()}`;
            
            if (!mesesAgrupados[mesAnio]) {
              mesesAgrupados[mesAnio] = {
                unidades: 0,
                valor: 0
              };
            }
            mesesAgrupados[mesAnio].unidades += item.unidades || 0;
            mesesAgrupados[mesAnio].valor += item.precio_total || 0;
          }
        });

        // Ordenar por fecha
        const mesesOrdenados = Object.entries(mesesAgrupados)
          .sort((a, b) => {
            const [mesA, anioA] = a[0].split('/').map(Number);
            const [mesB, anioB] = b[0].split('/').map(Number);
            return new Date(anioA, mesA - 1) - new Date(anioB, mesB - 1);
          });

        return {
          labels: mesesOrdenados.map(item => item[0]),
          datos: mesesOrdenados.map(item => item[1].unidades),
          valores: mesesOrdenados.map(item => item[1].valor)
        };
      }

      // Preparar datos para gráfico de distribución por concepto
      function prepararDatosDistribucionConcepto(datos) {
        const conceptosAgrupados = {};
        
        datos.forEach(item => {
          const concepto = item.concepto || 'Sin concepto';
          if (!conceptosAgrupados[concepto]) {
            conceptosAgrupados[concepto] = {
              unidades: 0,
              valor: 0
            };
          }
          conceptosAgrupados[concepto].unidades += item.unidades || 0;
          conceptosAgrupados[concepto].valor += item.precio_total || 0;
        });

        return {
          labels: Object.keys(conceptosAgrupados),
          datos: Object.values(conceptosAgrupados).map(item => item.unidades),
          valores: Object.values(conceptosAgrupados).map(item => item.valor)
        };
      }

      // Función auxiliar para obtener gradientes
      function getGradientByIndex(index) {
        const gradients = [
          'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
          'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
          'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
          'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
          'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
          'linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)',
          'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)'
        ];
        return gradients[index % gradients.length];
      }

      // Función auxiliar para obtener colores
      function getColorByIndex(index, alpha = 1) {
        const colors = [
          `rgba(63, 114, 175, ${alpha})`,
          `rgba(231, 76, 60, ${alpha})`,
          `rgba(46, 204, 113, ${alpha})`,
          `rgba(243, 156, 18, ${alpha})`,
          `rgba(155, 89, 182, ${alpha})`,
          `rgba(52, 152, 219, ${alpha})`,
          `rgba(26, 188, 156, ${alpha})`,
          `rgba(241, 196, 15, ${alpha})`
        ];
        return colors[index % colors.length];
      }

      // Crear gráfico de repuestos más usados
      function crearGraficoRepuestosMasUsados(datos) {
        const ctx = document.getElementById('chart-repuestos-mas-usados').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.repuestosMasUsados) {
          charts.repuestosMasUsados.destroy();
        }
        
        charts.repuestosMasUsados = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Unidades',
              data: datos.datos,
              backgroundColor: 'rgba(63, 114, 175, 0.7)',
              borderColor: 'rgba(63, 114, 175, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Unidades'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Crear gráfico de repuestos por máquina
      function crearGraficoRepuestosPorMaquina(datos) {
        const ctx = document.getElementById('chart-repuestos-por-maquina').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.repuestosPorMaquina) {
          charts.repuestosPorMaquina.destroy();
        }
        
        charts.repuestosPorMaquina = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: datos.labels,
            datasets: [{
              data: datos.datos,
              backgroundColor: datos.labels.map((_, index) => getColorByIndex(index, 0.7)),
              borderColor: datos.labels.map((_, index) => getColorByIndex(index, 1)),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Crear gráfico de evolución mensual
      function crearGraficoEvolucionMensual(datos) {
        const ctx = document.getElementById('chart-evolucion-mensual').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.evolucionMensual) {
          charts.evolucionMensual.destroy();
        }
        
        charts.evolucionMensual = new Chart(ctx, {
          type: 'line',
          data: {
            labels: datos.labels,
            datasets: [
              {
                label: 'Unidades',
                data: datos.datos,
                borderColor: 'rgba(63, 114, 175, 1)',
                backgroundColor: 'rgba(63, 114, 175, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                yAxisID: 'y'
              },
              {
                label: 'Valor ($)',
                data: datos.valores,
                borderColor: 'rgba(231, 76, 60, 1)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Unidades'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Valor ($)'
                },
                grid: {
                  drawOnChartArea: false,
                },
              }
            }
          }
        });
      }

      // Crear gráfico de distribución por concepto
      function crearGraficoDistribucionConcepto(datos) {
        const ctx = document.getElementById('chart-distribucion-concepto').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.distribucionConcepto) {
          charts.distribucionConcepto.destroy();
        }
        
        charts.distribucionConcepto = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: datos.labels,
            datasets: [{
              data: datos.datos,
              backgroundColor: datos.labels.map((_, index) => getColorByIndex(index, 0.7)),
              borderColor: datos.labels.map((_, index) => getColorByIndex(index, 1)),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Función para manejar la selección de período
      function seleccionarPeriodo(periodo) {
        // Actualizar variable global
        periodoSeleccionado = periodo;
        
        // Actualizar estado visual de los botones
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Activar el botón seleccionado
        document.querySelector(`.periodo-btn[data-periodo="${periodo}"]`).classList.add('active');
        
        // Mostrar/ocultar campos de fecha según el período
        if (periodo === 'personalizado') {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'block';
          document.getElementById('fecha-fin-group').style.display = 'block';
        } else if (periodo === 'dia') {
          document.getElementById('fecha-personalizada-group').style.display = 'block';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        } else {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        }
      }

      // Función para mostrar modal de selección de datos
      function mostrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'flex';
        
        // Establecer valores actuales en los checkboxes
        document.getElementById('mostrar-estadisticas').checked = configuracionInforme.mostrarEstadisticas;
        document.getElementById('mostrar-tarjetas').checked = configuracionInforme.mostrarTarjetas;
        document.getElementById('mostrar-ranking').checked = configuracionInforme.mostrarRanking;
        document.getElementById('mostrar-graficos').checked = configuracionInforme.mostrarGraficos;
        document.getElementById('mostrar-comparacion').checked = configuracionInforme.mostrarComparacion;
        document.getElementById('mostrar-detalle').checked = configuracionInforme.mostrarDetalle;
      }

      // Función para cerrar modal de selección de datos
      function cerrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'none';
      }

      // Función para generar informe con la configuración seleccionada
      function generarInforme() {
        // Obtener configuración seleccionada
        configuracionInforme = {
          mostrarEstadisticas: document.getElementById('mostrar-estadisticas').checked,
          mostrarTarjetas: document.getElementById('mostrar-tarjetas').checked,
          mostrarRanking: document.getElementById('mostrar-ranking').checked,
          mostrarGraficos: document.getElementById('mostrar-graficos').checked,
          mostrarComparacion: document.getElementById('mostrar-comparacion').checked,
          mostrarDetalle: document.getElementById('mostrar-detalle').checked
        };

        // Cerrar modal
        cerrarModalSeleccionDatos();

        // Generar informe con la configuración seleccionada
        cargarDatosRepuestos();
        
        mostrarExito('Informe generado con éxito');
      }

      // Función para limpiar filtros
      function limpiarFiltros() {
        // Configurar período por defecto (mes)
        seleccionarPeriodo('mes');
        
        // Configurar fechas por defecto (último mes)
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setMonth(fechaInicio.getMonth() - 1);
        
        document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
        document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
        document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];
        
        document.getElementById('patente-filtro').value = '';
        document.getElementById('tipo-analisis').value = 'general';
        document.getElementById('ordenar-por').value = 'unidades';
        document.getElementById('mostrar-top').value = '0';
        
        // Ocultar detalle
        document.getElementById('detalle-container').style.display = 'none';
        
        // Cargar datos sin filtros
        cargarDatosRepuestos();
      }

      // Mostrar mensaje de error
      function mostrarError(mensaje) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = mensaje;
        errorElement.style.display = 'block';

        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }

      // Mostrar mensaje de éxito
      function mostrarExito(mensaje) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = mensaje;
        successElement.style.display = 'block';

        setTimeout(() => {
          successElement.style.display = 'none';
        }, 3000);
      }

      // Inicializar la aplicación cuando se cargue la página
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar eventos para los botones de período
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-periodo');
            seleccionarPeriodo(periodo);
          });
        });

        // Configurar eventos para cambios en filtros
        document.getElementById('patente-filtro').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        document.getElementById('tipo-analisis').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        document.getElementById('ordenar-por').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        document.getElementById('mostrar-top').addEventListener('change', function() {
          cargarDatosRepuestos();
        });

        await inicializarSupabase();
      });
    </script>
  </div>
</body>
</html>
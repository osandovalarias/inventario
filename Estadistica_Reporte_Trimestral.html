<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Inventario - Reporte Trimestral</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #3f72af;
      --color-secondary: #dbe2ef;
      --color-text: #112d4e;
      --color-accent: #2c5282;
      --color-success: #2ecc71;
      --color-error: #e74c3c;
      --color-warning: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      --header-bg-color: #2c5282;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--color-text);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background-color: var(--header-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    h2 {
      margin-top: 30px;
      font-size: 1.5rem;
    }

    h3 {
      text-align: left;
      color: var(--color-primary);
      border-bottom: none;
      padding-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: white;
      padding: 5px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .title-container {
      flex: 1;
    }

    .subtitle {
      text-align: center;
      color: #dbe2ef;
      margin-top: -10px;
      font-size: 1.1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--color-error);
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--color-primary);
    }

    .btn-info:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-print {
      background: #17a2b8;
    }

    .btn-print:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .status-message {
      padding: 15px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .success {
      background-color: #d4edda;
      color: var(--color-success);
      border-left: 4px solid var(--color-success);
    }

    .info {
      background-color: #e7f5ff;
      color: var(--color-primary);
      border-left: 4px solid var(--color-primary);
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .connection-success {
      background-color: var(--color-success);
      color: white;
    }

    .connection-error {
      background-color: var(--color-error);
      color: white;
    }

    .connection-loading {
      background-color: var(--color-primary);
      color: white;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .input-group input, 
    .input-group select, 
    .input-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .resultados-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
    }

    .tabla-resultados {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .tabla-resultados th {
      background-color: var(--color-primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .tabla-resultados td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tabla-resultados tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .tabla-resultados tr:hover {
      background-color: #f1f1f1;
    }

    /* Estilos para gráficos */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Estilos para filtros */
    .filters-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .trimestre-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .trimestre-btn {
      padding: 10px 20px;
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .trimestre-btn.active {
      background-color: var(--color-primary);
      color: white;
    }

    .trimestre-btn:hover {
      background-color: var(--color-secondary);
    }

    /* Estilos para estadísticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--color-primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para comparación trimestral */
    .comparison-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .comparison-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
      font-size: 1.2rem;
    }

    .comparison-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .comparison-item:last-child {
      border-bottom: none;
    }

    .comparison-label {
      font-weight: 600;
    }

    .comparison-value {
      font-weight: bold;
    }

    .comparison-trend {
      font-size: 0.8rem;
      margin-left: 5px;
    }

    .trend-up {
      color: var(--color-success);
    }

    .trend-down {
      color: var(--color-error);
    }

    .trend-neutral {
      color: #666;
    }

    /* Estilos para resumen trimestral */
    .resumen-trimestral {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .resumen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    .resumen-title {
      color: var(--color-primary);
      margin: 0;
    }

    .resumen-periodo {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .resumen-item {
      text-align: center;
      padding: 15px;
      background-color: var(--color-secondary);
      border-radius: var(--border-radius);
    }

    .resumen-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 5px;
    }

    .resumen-label {
      font-size: 0.9rem;
      color: var(--color-text);
    }

    /* Estilos para modal de selección de datos */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .modal-title {
      color: var(--color-primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .close-modal:hover {
      color: var(--color-error);
    }

    .data-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .data-selection-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .data-selection-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .data-selection-item label {
      font-weight: normal;
      margin-bottom: 0;
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .header-container {
        background-color: white !important;
        color: black !important;
        box-shadow: none;
        border: 1px solid #ddd;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .btn, .btn-group {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
      }

      .subtitle {
        color: #555 !important;
      }
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-wrapper {
        height: 250px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .comparison-container {
        grid-template-columns: 1fr;
      }
      
      .resumen-grid {
        grid-template-columns: 1fr;
      }
      
      .data-selection-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container">
        <div class="logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div>
          <h1>Control de Inventario</h1>
          <div class="subtitle">Reporte Trimestral - Análisis Detallado</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-print" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>

    <div id="error-message" class="status-message error hidden"></div>
    <div id="success-message" class="status-message success hidden"></div>

    <div class="filters-container">
      <h3>Selección de Trimestre</h3>
      <div class="filter-row">
        <div class="filter-group">
          <label for="anio-select">Año:</label>
          <select id="anio-select">
            <!-- Los años se cargarán dinámicamente -->
          </select>
        </div>
        <div class="filter-group">
          <label>Trimestre:</label>
          <div class="trimestre-selector">
            <button class="trimestre-btn active" data-trimestre="1">1er Trimestre</button>
            <button class="trimestre-btn" data-trimestre="2">2do Trimestre</button>
            <button class="trimestre-btn" data-trimestre="3">3er Trimestre</button>
            <button class="trimestre-btn" data-trimestre="4">4to Trimestre</button>
          </div>
        </div>
        <div class="filter-group">
          <label for="patente-filtro">Patente:</label>
          <select id="patente-filtro">
            <option value="">Todas las máquinas</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
        <button class="btn btn-primary" onclick="mostrarModalSeleccionDatos()">
          <i class="fas fa-file-alt"></i> Generar Informe
        </button>
      </div>
    </div>

    <!-- Modal para selección de datos -->
    <div id="modal-seleccion-datos" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Seleccionar Datos para el Informe</h3>
          <button class="close-modal" onclick="cerrarModalSeleccionDatos()">&times;</button>
        </div>
        <p>Seleccione qué elementos desea incluir en el informe:</p>
        
        <div class="data-selection-grid">
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-resumen" checked>
            <label for="mostrar-resumen">Resumen del Trimestre</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-comparacion" checked>
            <label for="mostrar-comparacion">Comparación Trimestral</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-graficos" checked>
            <label for="mostrar-graficos">Gráficos de Análisis</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-detalle" checked>
            <label for="mostrar-detalle">Detalle de Movimientos</label>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cerrarModalSeleccionDatos()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-success" onclick="generarInforme()">
            <i class="fas fa-check"></i> Generar Informe
          </button>
        </div>
      </div>
    </div>

    <div class="resumen-trimestral hidden" id="resumen-trimestral">
      <div class="resumen-header">
        <h3 class="resumen-title">Resumen del Trimestre</h3>
        <div class="resumen-periodo" id="resumen-periodo"></div>
      </div>
      <div class="resumen-grid" id="resumen-grid">
        <!-- El resumen se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="comparacion-container">
      <h3>Comparación Trimestral</h3>
      <div id="comparison-content">
        <!-- La comparación se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="graficos-container">
      <h3>Análisis Gráfico del Trimestre</h3>
      <div class="charts-container">
        <div class="chart-card">
          <h4 class="chart-title">Distribución por Tipo de Mantenimiento</h4>
          <div class="chart-wrapper">
            <canvas id="chart-distribucion-concepto"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Top 10 Repuestos del Trimestre</h4>
          <div class="chart-wrapper">
            <canvas id="chart-top-repuestos"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Evolución Mensual del Trimestre</h4>
          <div class="chart-wrapper">
            <canvas id="chart-evolucion-mensual"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Repuestos por Máquina</h4>
          <div class="chart-wrapper">
            <canvas id="chart-repuestos-maquina"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="resultados-container" id="detalle-container">
      <h3>Detalle de Movimientos del Trimestre</h3>
      <table class="tabla-resultados" id="tabla-detalle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Patente</th>
            <th>Producto</th>
            <th>Código</th>
            <th>Unidades</th>
            <th>Valor ($)</th>
            <th>Concepto</th>
            <th>Mecánico</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div id="connection-status" class="connection-status connection-loading hidden">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a la base de datos...
    </div>

    <script>
      // Variables globales
      let supabaseClient;
      let maquinasBase = [];
      let productosBase = [];
      let currentTrimestre = 1;
      let currentAnio = new Date().getFullYear();
      let charts = {};
      let datosTrimestreActual = null;
      let datosTrimestreAnterior = null;
      let configuracionInforme = {
        mostrarResumen: true,
        mostrarComparacion: true,
        mostrarGraficos: true,
        mostrarDetalle: true
      };

      // Función para inicializar Supabase
      async function inicializarSupabase() {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.classList.remove('hidden');

        try {
          // Configuración de Supabase
          const supabaseUrl = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';

          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

          // Verificar conexión obteniendo datos necesarios
          const [maquinas, productos] = await Promise.all([
            obtenerMaquinas(),
            obtenerProductosCatalogo()
          ]);

          connectionStatus.className = 'connection-status connection-success';
          connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a la base de datos';

          setTimeout(() => {
            connectionStatus.classList.add('hidden');
          }, 3000);

          // Actualizar lista de patentes
          if (maquinas && maquinas.length > 0) {
            maquinasBase = maquinas;
            const selectPatente = document.getElementById('patente-filtro');
            maquinas.forEach(maquina => {
              const option = document.createElement('option');
              option.value = maquina.patente;
              option.textContent = maquina.patente;
              selectPatente.appendChild(option);
            });
          }

          // Actualizar lista de productos
          if (productos && productos.length > 0) {
            productosBase = productos;
          }

          // Cargar años disponibles
          cargarAniosDisponibles();

          // Cargar datos iniciales
          await cargarDatosTrimestrales();

          return true;
        } catch (error) {
          console.error('Error al conectar con Supabase:', error);
          connectionStatus.className = 'connection-status connection-error';
          connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
          return false;
        }
      }

      // Función para obtener máquinas
      async function obtenerMaquinas() {
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('patente')
          .order('patente', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener productos del catálogo
      async function obtenerProductosCatalogo() {
        const { data, error } = await supabaseClient
          .from('productos')
          .select('id, codigo, nombre_producto')
          .order('id', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para cargar años disponibles
      async function cargarAniosDisponibles() {
        try {
          const { data, error } = await supabaseClient
            .from('registros')
            .select('fecha')
            .order('fecha', { ascending: false });

          if (error) throw error;

          // Extraer años únicos con validación de fechas
          const anios = [...new Set(data
            .map(item => {
              if (!item.fecha) return null;
              
              // Validar formato de fecha
              const fecha = new Date(item.fecha);
              if (isNaN(fecha.getTime())) {
                console.warn('Fecha inválida encontrada al cargar años:', item.fecha);
                return null;
              }
              
              return fecha.getFullYear();
            })
            .filter(anio => anio !== null)
          )];
          
          anios.sort((a, b) => b - a); // Ordenar descendente

          const selectAnio = document.getElementById('anio-select');
          selectAnio.innerHTML = '';

          anios.forEach(anio => {
            const option = document.createElement('option');
            option.value = anio;
            option.textContent = anio;
            if (anio === currentAnio) {
              option.selected = true;
            }
            selectAnio.appendChild(option);
          });

          // Si no hay años, usar el año actual
          if (anios.length === 0) {
            const option = document.createElement('option');
            option.value = currentAnio;
            option.textContent = currentAnio;
            option.selected = true;
            selectAnio.appendChild(option);
          }

        } catch (error) {
          console.error('Error al cargar años:', error);
        }
      }

      // Función para validar fecha
      function esFechaValida(fechaString) {
        if (!fechaString) return false;
        
        const fecha = new Date(fechaString);
        return !isNaN(fecha.getTime());
      }

      // Función para obtener rango de fechas del trimestre (CORREGIDA)
      function obtenerRangoTrimestre(trimestre, anio) {
        // Validar que los parámetros sean números válidos
        const trimestreNum = parseInt(trimestre);
        const anioNum = parseInt(anio);
        
        if (isNaN(trimestreNum) || isNaN(anioNum)) {
          console.error('Parámetros inválidos:', { trimestre, anio });
          // Usar valores por defecto seguros
          const fechaInicio = new Date(new Date().getFullYear(), 0, 1);
          const fechaFin = new Date(new Date().getFullYear(), 2, 31);
          
          return {
            inicio: fechaInicio.toISOString().split('T')[0],
            fin: fechaFin.toISOString().split('T')[0]
          };
        }

        // Asegurar que el trimestre esté entre 1 y 4
        const trimestreValido = Math.max(1, Math.min(4, trimestreNum));
        
        let fechaInicio, fechaFin;

        switch(trimestreValido) {
          case 1:
            fechaInicio = new Date(anioNum, 0, 1); // 1 de enero
            fechaFin = new Date(anioNum, 2, 31); // 31 de marzo
            break;
          case 2:
            fechaInicio = new Date(anioNum, 3, 1); // 1 de abril
            fechaFin = new Date(anioNum, 5, 30); // 30 de junio
            break;
          case 3:
            fechaInicio = new Date(anioNum, 6, 1); // 1 de julio
            fechaFin = new Date(anioNum, 8, 30); // 30 de septiembre
            break;
          case 4:
            fechaInicio = new Date(anioNum, 9, 1); // 1 de octubre
            fechaFin = new Date(anioNum, 11, 31); // 31 de diciembre
            break;
          default:
            fechaInicio = new Date(anioNum, 0, 1);
            fechaFin = new Date(anioNum, 2, 31);
        }

        // Validar que las fechas sean válidas
        if (isNaN(fechaInicio.getTime()) || isNaN(fechaFin.getTime())) {
          console.error('Fechas inválidas generadas:', { fechaInicio, fechaFin });
          // Usar valores por defecto
          fechaInicio = new Date(new Date().getFullYear(), 0, 1);
          fechaFin = new Date(new Date().getFullYear(), 2, 31);
        }

        return {
          inicio: fechaInicio.toISOString().split('T')[0],
          fin: fechaFin.toISOString().split('T')[0]
        };
      }

      // Función para obtener datos trimestrales
      async function obtenerDatosTrimestrales(trimestre, anio, patente = '') {
        try {
          // Validar parámetros antes de continuar
          if (isNaN(parseInt(trimestre)) || isNaN(parseInt(anio))) {
            console.error('Parámetros inválidos para obtener datos:', { trimestre, anio });
            return [];
          }
          
          const rango = obtenerRangoTrimestre(trimestre, anio);
          console.log('Consultando datos para:', { trimestre, anio, rango, patente });

          let query = supabaseClient
            .from('registros')
            .select('*')
            .eq('estado', 'salida')
            .gte('fecha', rango.inicio)
            .lte('fecha', rango.fin)
            .order('fecha', { ascending: false });

          if (patente) {
            query = query.eq('patente', patente);
          }

          const { data, error } = await query;

          if (error) {
            console.error('Error en consulta Supabase:', error);
            throw error;
          }
          
          console.log(`Datos obtenidos: ${data ? data.length : 0} registros`);
          
          // Filtrar registros con fechas inválidas
          return data ? data.filter(item => esFechaValida(item.fecha)) : [];
        } catch (error) {
          console.error('Error en obtenerDatosTrimestrales:', error);
          mostrarError(`Error al obtener datos: ${error.message}`);
          return [];
        }
      }

      // Función para cargar datos trimestrales
      async function cargarDatosTrimestrales() {
        try {
          // Mostrar indicador de carga
          mostrarInfo('Cargando datos...');

          // Obtener valores de filtros
          const anioSelect = document.getElementById('anio-select');
          const anioValue = anioSelect.value;
          
          // Validar año seleccionado
          if (!anioValue || isNaN(parseInt(anioValue))) {
            currentAnio = new Date().getFullYear();
            anioSelect.value = currentAnio;
          } else {
            currentAnio = parseInt(anioValue);
          }
          
          const patente = document.getElementById('patente-filtro').value;

          console.log('Cargando datos para:', {
            trimestre: currentTrimestre,
            anio: currentAnio,
            patente: patente || 'Todas'
          });

          // Obtener datos del trimestre actual
          datosTrimestreActual = await obtenerDatosTrimestrales(currentTrimestre, currentAnio, patente);
          console.log('Datos trimestre actual:', datosTrimestreActual?.length);

          // Obtener datos del trimestre anterior para comparación
          let trimestreAnterior = currentTrimestre - 1;
          let anioAnterior = currentAnio;
          
          if (trimestreAnterior === 0) {
            trimestreAnterior = 4;
            anioAnterior = currentAnio - 1;
          }
          
          datosTrimestreAnterior = await obtenerDatosTrimestrales(trimestreAnterior, anioAnterior, patente);
          console.log('Datos trimestre anterior:', datosTrimestreAnterior?.length);

          // Ocultar indicador de carga
          document.getElementById('success-message').classList.add('hidden');

          // Actualizar interfaz
          actualizarVistaInforme();

          // Mostrar mensaje de éxito si hay datos
          if (datosTrimestreActual && datosTrimestreActual.length > 0) {
            mostrarExito(`Se cargaron ${datosTrimestreActual.length} registros del trimestre`);
          } else {
            mostrarInfo('No se encontraron registros para el trimestre seleccionado');
          }

        } catch (error) {
          console.error('Error al cargar datos trimestrales:', error);
          mostrarError(`Error: ${error.message}`);
        }
      }

      // Función para actualizar la vista según la configuración del informe
      function actualizarVistaInforme() {
        // Mostrar/ocultar secciones según configuración
        document.getElementById('resumen-trimestral').style.display = 
          configuracionInforme.mostrarResumen ? 'block' : 'none';
        document.getElementById('comparacion-container').style.display = 
          configuracionInforme.mostrarComparacion ? 'block' : 'none';
        document.getElementById('graficos-container').style.display = 
          configuracionInforme.mostrarGraficos ? 'block' : 'none';
        document.getElementById('detalle-container').style.display = 
          configuracionInforme.mostrarDetalle ? 'block' : 'none';

        // Actualizar contenido de cada sección
        if (configuracionInforme.mostrarResumen) {
          actualizarResumenTrimestral();
        }
        
        if (configuracionInforme.mostrarComparacion) {
          actualizarComparacionTrimestral();
        }
        
        if (configuracionInforme.mostrarGraficos) {
          actualizarGraficos();
        }
        
        if (configuracionInforme.mostrarDetalle) {
          actualizarTablaDetalle();
        }
      }

      // Función para actualizar resumen trimestral
      function actualizarResumenTrimestral() {
        const resumenContainer = document.getElementById('resumen-trimestral');
        const resumenPeriodo = document.getElementById('resumen-periodo');
        const resumenGrid = document.getElementById('resumen-grid');

        if (!datosTrimestreActual || datosTrimestreActual.length === 0) {
          resumenContainer.classList.add('hidden');
          return;
        }

        resumenContainer.classList.remove('hidden');

        // Calcular estadísticas
        const totalMovimientos = datosTrimestreActual.length;
        const totalUnidades = datosTrimestreActual.reduce((sum, item) => sum + (item.unidades || 0), 0);
        const totalValor = datosTrimestreActual.reduce((sum, item) => sum + (item.precio_total || 0), 0);
        const maquinasUnicas = [...new Set(datosTrimestreActual.map(item => item.patente))].length;
        const productosUnicos = [...new Set(datosTrimestreActual.map(item => item.codigo))].length;
        const promedioValor = totalMovimientos > 0 ? (totalValor / totalMovimientos).toFixed(2) : 0;

        // Actualizar período
        const nombresTrimestres = ['Primer', 'Segundo', 'Tercer', 'Cuarto'];
        resumenPeriodo.textContent = `${nombresTrimestres[currentTrimestre - 1]} Trimestre ${currentAnio}`;

        // Crear HTML del resumen
        resumenGrid.innerHTML = `
          <div class="resumen-item">
            <div class="resumen-value">${totalMovimientos}</div>
            <div class="resumen-label">Total Movimientos</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-value">${totalUnidades}</div>
            <div class="resumen-label">Total Unidades</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-value">$${totalValor.toLocaleString('es-CL')}</div>
            <div class="resumen-label">Valor Total</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-value">${maquinasUnicas}</div>
            <div class="resumen-label">Máquinas</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-value">${productosUnicos}</div>
            <div class="resumen-label">Productos Diferentes</div>
          </div>
          <div class="resumen-item">
            <div class="resumen-value">$${promedioValor}</div>
            <div class="resumen-label">Promedio por Movimiento</div>
          </div>
        `;
      }

      // Función para actualizar comparación trimestral
      function actualizarComparacionTrimestral() {
        const comparisonContainer = document.getElementById('comparison-content');

        if (!datosTrimestreAnterior || datosTrimestreAnterior.length === 0) {
          comparisonContainer.innerHTML = `
            <div class="comparison-card">
              <h4 class="comparison-title">Comparación Trimestral</h4>
              <p style="text-align: center; padding: 20px;">No hay datos del trimestre anterior para comparar</p>
            </div>
          `;
          return;
        }

        // Calcular estadísticas del trimestre actual
        const totalMovimientosActual = datosTrimestreActual.length;
        const totalUnidadesActual = datosTrimestreActual.reduce((sum, item) => sum + (item.unidades || 0), 0);
        const totalValorActual = datosTrimestreActual.reduce((sum, item) => sum + (item.precio_total || 0), 0);

        // Calcular estadísticas del trimestre anterior
        const totalMovimientosAnterior = datosTrimestreAnterior.length;
        const totalUnidadesAnterior = datosTrimestreAnterior.reduce((sum, item) => sum + (item.unidades || 0), 0);
        const totalValorAnterior = datosTrimestreAnterior.reduce((sum, item) => sum + (item.precio_total || 0), 0);

        // Calcular variaciones
        const variacionMovimientos = calcularVariacion(totalMovimientosActual, totalMovimientosAnterior);
        const variacionUnidades = calcularVariacion(totalUnidadesActual, totalUnidadesAnterior);
        const variacionValor = calcularVariacion(totalValorActual, totalValorAnterior);

        // Crear HTML de comparación
        comparisonContainer.innerHTML = `
          <div class="comparison-container">
            <div class="comparison-card">
              <h4 class="comparison-title">Movimientos</h4>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Actual:</span>
                <span class="comparison-value">${totalMovimientosActual}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Anterior:</span>
                <span class="comparison-value">${totalMovimientosAnterior}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Variación:</span>
                <span class="comparison-value ${variacionMovimientos.trend}">
                  ${variacionMovimientos.porcentaje}%
                  <span class="comparison-trend ${variacionMovimientos.trend}">
                    ${variacionMovimientos.trend === 'trend-up' ? '↗' : variacionMovimientos.trend === 'trend-down' ? '↘' : '→'}
                  </span>
                </span>
              </div>
            </div>
            <div class="comparison-card">
              <h4 class="comparison-title">Unidades</h4>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Actual:</span>
                <span class="comparison-value">${totalUnidadesActual}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Anterior:</span>
                <span class="comparison-value">${totalUnidadesAnterior}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Variación:</span>
                <span class="comparison-value ${variacionUnidades.trend}">
                  ${variacionUnidades.porcentaje}%
                  <span class="comparison-trend ${variacionUnidades.trend}">
                    ${variacionUnidades.trend === 'trend-up' ? '↗' : variacionUnidades.trend === 'trend-down' ? '↘' : '→'}
                  </span>
                </span>
              </div>
            </div>
            <div class="comparison-card">
              <h4 class="comparison-title">Valor Total</h4>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Actual:</span>
                <span class="comparison-value">$${totalValorActual.toLocaleString('es-CL')}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Trimestre Anterior:</span>
                <span class="comparison-value">$${totalValorAnterior.toLocaleString('es-CL')}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Variación:</span>
                <span class="comparison-value ${variacionValor.trend}">
                  ${variacionValor.porcentaje}%
                  <span class="comparison-trend ${variacionValor.trend}">
                    ${variacionValor.trend === 'trend-up' ? '↗' : variacionValor.trend === 'trend-down' ? '↘' : '→'}
                  </span>
                </span>
              </div>
            </div>
          </div>
        `;
      }

      // Función para calcular variación porcentual
      function calcularVariacion(actual, anterior) {
        if (anterior === 0) {
          return {
            porcentaje: actual > 0 ? '100' : '0',
            trend: actual > 0 ? 'trend-up' : 'trend-neutral'
          };
        }

        const variacion = ((actual - anterior) / anterior) * 100;
        const porcentaje = Math.abs(variacion).toFixed(1);
        
        let trend = 'trend-neutral';
        if (variacion > 5) trend = 'trend-up';
        else if (variacion < -5) trend = 'trend-down';

        return {
          porcentaje: variacion > 0 ? `+${porcentaje}` : `-${porcentaje}`,
          trend: trend
        };
      }

      // Función para actualizar tabla de detalle
      function actualizarTablaDetalle() {
        const tbody = document.getElementById('tabla-detalle').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (!datosTrimestreActual || datosTrimestreActual.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron movimientos en este trimestre</td></tr>';
          return;
        }

        datosTrimestreActual.forEach(item => {
          const row = tbody.insertRow();
          
          // Fecha
          const fechaCell = row.insertCell(0);
          fechaCell.textContent = item.fecha || '-';
          
          // Patente
          const patenteCell = row.insertCell(1);
          patenteCell.textContent = item.patente || '-';
          
          // Producto
          const productoCell = row.insertCell(2);
          productoCell.textContent = item.nombre || '-';
          
          // Código
          const codigoCell = row.insertCell(3);
          codigoCell.textContent = item.codigo || '-';
          
          // Unidades
          const unidadesCell = row.insertCell(4);
          unidadesCell.textContent = item.unidades || '0';
          
          // Valor
          const valorCell = row.insertCell(5);
          valorCell.textContent = '$' + (item.precio_total || 0).toLocaleString('es-CL');
          
          // Concepto
          const conceptoCell = row.insertCell(6);
          conceptoCell.textContent = item.concepto || '-';
          
          // Mecánico
          const mecanicoCell = row.insertCell(7);
          mecanicoCell.textContent = item.mecanico || 'Mecánico';
        });
      }

      // Función para actualizar gráficos
      function actualizarGraficos() {
        // Preparar datos para gráficos
        const datosGraficoConcepto = prepararDatosDistribucionConcepto(datosTrimestreActual);
        const datosGraficoRepuestos = prepararDatosTopRepuestos(datosTrimestreActual);
        const datosGraficoEvolucion = prepararDatosEvolucionMensual(datosTrimestreActual);
        const datosGraficoMaquinas = prepararDatosRepuestosPorMaquina(datosTrimestreActual);

        // Crear o actualizar gráficos
        crearGraficoDistribucionConcepto(datosGraficoConcepto);
        crearGraficoTopRepuestos(datosGraficoRepuestos);
        crearGraficoEvolucionMensual(datosGraficoEvolucion);
        crearGraficoRepuestosPorMaquina(datosGraficoMaquinas);
      }

      // Preparar datos para gráfico de distribución por concepto
      function prepararDatosDistribucionConcepto(datos) {
        const conceptosAgrupados = {};
        
        datos.forEach(item => {
          const concepto = item.concepto || 'Sin concepto';
          if (!conceptosAgrupados[concepto]) {
            conceptosAgrupados[concepto] = {
              unidades: 0,
              valor: 0
            };
          }
          conceptosAgrupados[concepto].unidades += item.unidades || 0;
          conceptosAgrupados[concepto].valor += item.precio_total || 0;
        });

        return {
          labels: Object.keys(conceptosAgrupados),
          datos: Object.values(conceptosAgrupados).map(item => item.unidades),
          valores: Object.values(conceptosAgrupados).map(item => item.valor)
        };
      }

      // Preparar datos para gráfico de top repuestos
      function prepararDatosTopRepuestos(datos) {
        const productosAgrupados = {};
        
        datos.forEach(item => {
          const clave = `${item.codigo} - ${item.nombre}`;
          if (!productosAgrupados[clave]) {
            productosAgrupados[clave] = {
              unidades: 0,
              valor: 0
            };
          }
          productosAgrupados[clave].unidades += item.unidades || 0;
          productosAgrupados[clave].valor += item.precio_total || 0;
        });

        // Ordenar por unidades (descendente) y tomar los 10 primeros
        const productosOrdenados = Object.entries(productosAgrupados)
          .sort((a, b) => b[1].unidades - a[1].unidades)
          .slice(0, 10);

        return {
          labels: productosOrdenados.map(item => item[0]),
          datos: productosOrdenados.map(item => item[1].unidades),
          valores: productosOrdenados.map(item => item[1].valor)
        };
      }

      // Preparar datos para gráfico de evolución mensual
      function prepararDatosEvolucionMensual(datos) {
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        const mesesAgrupados = {};
        
        datos.forEach(item => {
          if (item.fecha && esFechaValida(item.fecha)) {
            const fecha = new Date(item.fecha);
            const mes = fecha.getMonth(); // 0-11
            
            if (!mesesAgrupados[mes]) {
              mesesAgrupados[mes] = {
                unidades: 0,
                valor: 0
              };
            }
            mesesAgrupados[mes].unidades += item.unidades || 0;
            mesesAgrupados[mes].valor += item.precio_total || 0;
          }
        });

        // Obtener los meses del trimestre actual
        const mesesTrimestre = [];
        for (let i = (currentTrimestre - 1) * 3; i < currentTrimestre * 3; i++) {
          mesesTrimestre.push(i);
        }

        return {
          labels: mesesTrimestre.map(mes => meses[mes]),
          datos: mesesTrimestre.map(mes => mesesAgrupados[mes] ? mesesAgrupados[mes].unidades : 0),
          valores: mesesTrimestre.map(mes => mesesAgrupados[mes] ? mesesAgrupados[mes].valor : 0)
        };
      }

      // Preparar datos para gráfico de repuestos por máquina
      function prepararDatosRepuestosPorMaquina(datos) {
        const maquinasAgrupadas = {};
        
        datos.forEach(item => {
          const patente = item.patente || 'Sin patente';
          if (!maquinasAgrupadas[patente]) {
            maquinasAgrupadas[patente] = {
              unidades: 0,
              valor: 0
            };
          }
          maquinasAgrupadas[patente].unidades += item.unidades || 0;
          maquinasAgrupadas[patente].valor += item.precio_total || 0;
        });

        return {
          labels: Object.keys(maquinasAgrupadas),
          datos: Object.values(maquinasAgrupadas).map(item => item.unidades),
          valores: Object.values(maquinasAgrupadas).map(item => item.valor)
        };
      }

      // Crear gráfico de distribución por concepto
      function crearGraficoDistribucionConcepto(datos) {
        const ctx = document.getElementById('chart-distribucion-concepto').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.distribucionConcepto) {
          charts.distribucionConcepto.destroy();
        }
        
        // Si no hay datos, mostrar mensaje
        if (!datos || datos.datos.length === 0) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = '16px Arial';
          ctx.fillStyle = '#666';
          ctx.textAlign = 'center';
          ctx.fillText('No hay datos para mostrar', ctx.canvas.width/2, ctx.canvas.height/2);
          return;
        }
        
        charts.distribucionConcepto = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: datos.labels,
            datasets: [{
              data: datos.datos,
              backgroundColor: [
                'rgba(63, 114, 175, 0.7)',
                'rgba(219, 226, 239, 0.7)',
                'rgba(44, 82, 130, 0.7)',
                'rgba(17, 45, 78, 0.7)',
                'rgba(46, 204, 113, 0.7)',
                'rgba(231, 76, 60, 0.7)',
                'rgba(243, 156, 18, 0.7)',
                'rgba(155, 89, 182, 0.7)',
                'rgba(26, 188, 156, 0.7)',
                'rgba(52, 152, 219, 0.7)'
              ],
              borderColor: [
                'rgba(63, 114, 175, 1)',
                'rgba(219, 226, 239, 1)',
                'rgba(44, 82, 130, 1)',
                'rgba(17, 45, 78, 1)',
                'rgba(46, 204, 113, 1)',
                'rgba(231, 76, 60, 1)',
                'rgba(243, 156, 18, 1)',
                'rgba(155, 89, 182, 1)',
                'rgba(26, 188, 156, 1)',
                'rgba(52, 152, 219, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Crear gráfico de top repuestos
      function crearGraficoTopRepuestos(datos) {
        const ctx = document.getElementById('chart-top-repuestos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.topRepuestos) {
          charts.topRepuestos.destroy();
        }
        
        // Si no hay datos, mostrar mensaje
        if (!datos || datos.datos.length === 0) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = '16px Arial';
          ctx.fillStyle = '#666';
          ctx.textAlign = 'center';
          ctx.fillText('No hay datos para mostrar', ctx.canvas.width/2, ctx.canvas.height/2);
          return;
        }
        
        charts.topRepuestos = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Unidades',
              data: datos.datos,
              backgroundColor: 'rgba(63, 114, 175, 0.7)',
              borderColor: 'rgba(63, 114, 175, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Unidades'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Crear gráfico de evolución mensual
      function crearGraficoEvolucionMensual(datos) {
        const ctx = document.getElementById('chart-evolucion-mensual').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.evolucionMensual) {
          charts.evolucionMensual.destroy();
        }
        
        // Si no hay datos, mostrar mensaje
        if (!datos || datos.datos.length === 0) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = '16px Arial';
          ctx.fillStyle = '#666';
          ctx.textAlign = 'center';
          ctx.fillText('No hay datos para mostrar', ctx.canvas.width/2, ctx.canvas.height/2);
          return;
        }
        
        charts.evolucionMensual = new Chart(ctx, {
          type: 'line',
          data: {
            labels: datos.labels,
            datasets: [
              {
                label: 'Unidades',
                data: datos.datos,
                borderColor: 'rgba(63, 114, 175, 1)',
                backgroundColor: 'rgba(63, 114, 175, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                yAxisID: 'y'
              },
              {
                label: 'Valor ($)',
                data: datos.valores,
                borderColor: 'rgba(231, 76, 60, 1)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Unidades'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Valor ($)'
                },
                grid: {
                  drawOnChartArea: false,
                },
              }
            }
          }
        });
      }

      // Crear gráfico de repuestos por máquina
      function crearGraficoRepuestosPorMaquina(datos) {
        const ctx = document.getElementById('chart-repuestos-maquina').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.repuestosMaquina) {
          charts.repuestosMaquina.destroy();
        }
        
        // Si no hay datos, mostrar mensaje
        if (!datos || datos.datos.length === 0) {
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          ctx.font = '16px Arial';
          ctx.fillStyle = '#666';
          ctx.textAlign = 'center';
          ctx.fillText('No hay datos para mostrar', ctx.canvas.width/2, ctx.canvas.height/2);
          return;
        }
        
        charts.repuestosMaquina = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Unidades',
              data: datos.datos,
              backgroundColor: 'rgba(46, 204, 113, 0.7)',
              borderColor: 'rgba(46, 204, 113, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Unidades'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const index = context.dataIndex;
                    const valor = datos.valores[index];
                    return `Valor: $${valor.toLocaleString('es-CL')}`;
                  }
                }
              }
            }
          }
        });
      }

      // Función para mostrar modal de selección de datos
      function mostrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'flex';
        
        // Establecer valores actuales en los checkboxes
        document.getElementById('mostrar-resumen').checked = configuracionInforme.mostrarResumen;
        document.getElementById('mostrar-comparacion').checked = configuracionInforme.mostrarComparacion;
        document.getElementById('mostrar-graficos').checked = configuracionInforme.mostrarGraficos;
        document.getElementById('mostrar-detalle').checked = configuracionInforme.mostrarDetalle;
      }

      // Función para cerrar modal de selección de datos
      function cerrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'none';
      }

      // Función para generar informe con la configuración seleccionada
      function generarInforme() {
        // Obtener configuración seleccionada
        configuracionInforme = {
          mostrarResumen: document.getElementById('mostrar-resumen').checked,
          mostrarComparacion: document.getElementById('mostrar-comparacion').checked,
          mostrarGraficos: document.getElementById('mostrar-graficos').checked,
          mostrarDetalle: document.getElementById('mostrar-detalle').checked
        };

        // Cerrar modal
        cerrarModalSeleccionDatos();

        // Generar informe con la configuración seleccionada
        cargarDatosTrimestrales();
        
        mostrarExito('Informe generado con éxito');
      }

      // Función para limpiar filtros
      function limpiarFiltros() {
        document.getElementById('patente-filtro').value = '';
        
        // Restablecer trimestre a 1
        document.querySelectorAll('.trimestre-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector('.trimestre-btn[data-trimestre="1"]').classList.add('active');
        currentTrimestre = 1;
        
        // Restablecer configuración de informe
        configuracionInforme = {
          mostrarResumen: true,
          mostrarComparacion: true,
          mostrarGraficos: true,
          mostrarDetalle: true
        };
        
        // Cargar datos sin filtros
        cargarDatosTrimestrales();
      }

      // Mostrar mensaje de error
      function mostrarError(mensaje) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = mensaje;
        errorElement.classList.remove('hidden');

        setTimeout(() => {
          errorElement.classList.add('hidden');
        }, 5000);
      }

      // Mostrar mensaje de éxito
      function mostrarExito(mensaje) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = mensaje;
        successElement.classList.remove('hidden');

        setTimeout(() => {
          successElement.classList.add('hidden');
        }, 3000);
      }

      // Mostrar mensaje de información
      function mostrarInfo(mensaje) {
        const infoElement = document.getElementById('success-message');
        infoElement.className = 'status-message info';
        infoElement.textContent = mensaje;
        infoElement.classList.remove('hidden');
      }

      // Inicializar la aplicación cuando se cargue la página
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar eventos para botones de trimestre
        document.querySelectorAll('.trimestre-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.trimestre-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTrimestre = parseInt(this.dataset.trimestre);
            cargarDatosTrimestrales();
          });
        });

        // Configurar evento para cambio de año
        document.getElementById('anio-select').addEventListener('change', function() {
          cargarDatosTrimestrales();
        });

        // Configurar evento para cambio de patente
        document.getElementById('patente-filtro').addEventListener('change', function() {
          cargarDatosTrimestrales();
        });

        await inicializarSupabase();
      });
    </script>
  </div>
</body>
</html>

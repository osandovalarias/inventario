<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Inventario - Gastos por Máquina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #3f72af;
      --color-secondary: #dbe2ef;
      --color-text: #112d4e;
      --color-accent: #2c5282;
      --color-success: #2ecc71;
      --color-error: #e74c3c;
      --color-warning: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      --header-bg-color: #2c5282;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--color-text);
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background-color: var(--header-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    h2 {
      margin-top: 30px;
      font-size: 1.5rem;
    }

    h3 {
      text-align: left;
      color: var(--color-primary);
      border-bottom: none;
      padding-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: white;
      padding: 5px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .title-container {
      flex: 1;
    }

    .subtitle {
      text-align: center;
      color: #dbe2ef;
      margin-top: -10px;
      font-size: 1.1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--color-error);
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--color-primary);
    }

    .btn-info:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-print {
      background: #17a2b8;
    }

    .btn-print:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .status-message {
      padding: 15px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .success {
      background-color: #d4edda;
      color: var(--color-success);
      border-left: 4px solid var(--color-success);
    }

    .info {
      background-color: #e7f5ff;
      color: var(--color-primary);
      border-left: 4px solid var(--color-primary);
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .connection-success {
      background-color: var(--color-success);
      color: white;
    }

    .connection-error {
      background-color: var(--color-error);
      color: white;
    }

    .connection-loading {
      background-color: var(--color-primary);
      color: white;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .input-group input, 
    .input-group select, 
    .input-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .resultados-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
    }

    .tabla-resultados {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .tabla-resultados th {
      background-color: var(--color-primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .tabla-resultados td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tabla-resultados tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .tabla-resultados tr:hover {
      background-color: #f1f1f1;
    }

    /* Estilos para gráficos */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    /* Estilos para filtros */
    .filters-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    /* Estilos para selector de períodos */
    .periodo-selector-container {
      margin-bottom: 20px;
    }

    .periodo-selector-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .periodo-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .periodo-btn {
      padding: 10px 20px;
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
      flex: 1;
      min-width: 120px;
      max-width: 150px;
    }

    .periodo-btn.active {
      background-color: var(--color-primary);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .periodo-btn:hover:not(.active) {
      background-color: var(--color-secondary);
    }

    /* Estilos para estadísticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para tarjetas de máquinas */
    .maquinas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .maquina-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .maquina-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .maquina-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .maquina-patente {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .maquina-ranking {
      background-color: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .maquina-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .maquina-stat {
      text-align: center;
    }

    .maquina-stat-value {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .maquina-stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .maquina-progress {
      background-color: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .maquina-progress-bar {
      height: 100%;
      background-color: white;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .maquina-percentage {
      text-align: right;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Estilos para comparación */
    .comparison-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .comparison-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
      font-size: 1.2rem;
    }

    .comparison-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .comparison-item:last-child {
      border-bottom: none;
    }

    .comparison-label {
      font-weight: 600;
    }

    .comparison-value {
      font-weight: bold;
    }

    /* Estilos para tabla de detalle por máquina */
    .detalle-maquina {
      margin-top: 30px;
    }

    .detalle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    .detalle-title {
      color: var(--color-primary);
      margin: 0;
    }

    .detalle-patente {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--color-text);
    }

    /* Estilos para indicadores de tendencia */
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .trend-up {
      color: var(--color-success);
    }

    .trend-down {
      color: var(--color-error);
    }

    .trend-neutral {
      color: #666;
    }

    /* Estilos para tabla de ranking */
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .ranking-table th {
      background-color: var(--color-primary);
      color: white;
      padding: 12px;
      text-align: center;
    }

    .ranking-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    .ranking-table .ranking-cell {
      width: 50px;
      text-align: center;
    }

    .ranking-table .top-1 {
      background-color: #FFD700;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .ranking-table .top-2 {
      background-color: #C0C0C0;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .ranking-table .top-3 {
      background-color: #CD7F32;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    /* Estilos para modal de selección de datos */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    .modal-title {
      color: var(--color-primary);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .close-modal:hover {
      color: var(--color-error);
    }

    .data-selection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .data-selection-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .data-selection-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .data-selection-item label {
      font-weight: normal;
      margin-bottom: 0;
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .header-container {
        background-color: white !important;
        color: black !important;
        box-shadow: none;
        border: 1px solid #ddd;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .btn, .btn-group {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
      }

      .subtitle {
        color: #555 !important;
      }

      .maquinas-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-wrapper {
        height: 300px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .maquinas-grid {
        grid-template-columns: 1fr;
      }
      
      .comparison-container {
        grid-template-columns: 1fr;
      }
      
      .maquina-stats {
        grid-template-columns: 1fr;
      }
      
      .data-selection-grid {
        grid-template-columns: 1fr;
      }
      
      .periodo-selector {
        flex-direction: column;
      }
      
      .periodo-btn {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container">
        <div class="logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div>
          <h1>Control de Inventario</h1>
          <div class="subtitle">Reporte de Gastos por Máquina - Distribución Completa</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-print" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>

    <div id="error-message" class="status-message error" style="display: none;"></div>
    <div id="success-message" class="status-message success" style="display: none;"></div>

    <div class="filters-container">
      <h3>Configuración del Informe</h3>
      
      <!-- Selector de períodos como etiquetas -->
      <div class="periodo-selector-container">
        <label class="periodo-selector-label">Seleccione el período:</label>
        <div class="periodo-selector">
          <div class="periodo-btn active" data-periodo="dia">Día</div>
          <div class="periodo-btn" data-periodo="semana">Semana</div>
          <div class="periodo-btn" data-periodo="mes">Mes</div>
          <div class="periodo-btn" data-periodo="bimestre">Bimestre</div>
          <div class="periodo-btn" data-periodo="trimestre">Trimestre</div>
          <div class="periodo-btn" data-periodo="cuatrimestre">Cuatrimestre</div>
          <div class="periodo-btn" data-periodo="semestre">Semestre</div>
          <div class="periodo-btn" data-periodo="anio">Año</div>
          <div class="periodo-btn" data-periodo="personalizado">Personalizado</div>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group" id="fecha-personalizada-group" style="display: none;">
          <label for="fecha-personalizada">Fecha:</label>
          <input type="date" id="fecha-personalizada">
        </div>
        <div class="filter-group" id="fecha-inicio-group" style="display: none;">
          <label for="fecha-inicio">Fecha de Inicio:</label>
          <input type="date" id="fecha-inicio">
        </div>
        <div class="filter-group" id="fecha-fin-group" style="display: none;">
          <label for="fecha-fin">Fecha de Fin:</label>
          <input type="date" id="fecha-fin">
        </div>
        <div class="filter-group">
          <label for="tipo-analisis">Tipo de Análisis:</label>
          <select id="tipo-analisis">
            <option value="general">Vista General</option>
            <option value="detallado">Vista Detallada</option>
            <option value="comparativo">Análisis Comparativo</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Ordenar por:</label>
          <select id="ordenar-por">
            <option value="gastos">Gastos Totales</option>
            <option value="movimientos">Cantidad de Movimientos</option>
            <option value="unidades">Unidades Utilizadas</option>
            <option value="promedio">Costo Promedio</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="mostrar-top">Mostrar:</label>
          <select id="mostrar-top">
            <option value="0">Todas las máquinas</option>
            <option value="5">Top 5</option>
            <option value="10">Top 10</option>
            <option value="15">Top 15</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
        <button class="btn btn-primary" onclick="mostrarModalSeleccionDatos()">
          <i class="fas fa-file-alt"></i> Generar Informe
        </button>
      </div>
    </div>

    <!-- Modal para selección de datos -->
    <div id="modal-seleccion-datos" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Seleccionar Datos para el Informe</h3>
          <button class="close-modal" onclick="cerrarModalSeleccionDatos()">&times;</button>
        </div>
        <p>Seleccione qué elementos desea incluir en el informe:</p>
        
        <div class="data-selection-grid">
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-estadisticas" checked>
            <label for="mostrar-estadisticas">Estadísticas Generales</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-tarjetas" checked>
            <label for="mostrar-tarjetas">Tarjetas de Máquinas</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-ranking" checked>
            <label for="mostrar-ranking">Ranking de Máquinas</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-graficos" checked>
            <label for="mostrar-graficos">Gráficos de Distribución</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-comparacion" checked>
            <label for="mostrar-comparacion">Análisis Comparativo</label>
          </div>
          <div class="data-selection-item">
            <input type="checkbox" id="mostrar-detalle" checked>
            <label for="mostrar-detalle">Detalle por Máquina</label>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cerrarModalSeleccionDatos()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button class="btn btn-success" onclick="generarInforme()">
            <i class="fas fa-check"></i> Generar Informe
          </button>
        </div>
      </div>
    </div>

    <div class="stats-container" id="stats-container">
      <!-- Las estadísticas se cargarán dinámicamente -->
    </div>

    <div class="resultados-container" id="tarjetas-container">
      <h3>Distribución de Gastos por Máquina</h3>
      <div class="maquinas-grid" id="maquinas-grid">
        <!-- Las tarjetas de máquinas se cargarán dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="ranking-container">
      <h3>Ranking de Máquinas por Gastos</h3>
      <table class="ranking-table" id="tabla-ranking">
        <thead>
          <tr>
            <th>Posición</th>
            <th>Patente</th>
            <th>Gastos Totales</th>
            <th>Movimientos</th>
            <th>Unidades</th>
            <th>Costo Promedio</th>
            <th>% del Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div class="resultados-container" id="graficos-container">
      <h3>Análisis Gráfico de Distribución</h3>
      <div class="charts-container">
        <div class="chart-card">
          <h4 class="chart-title">Distribución de Gastos por Máquina</h4>
          <div class="chart-wrapper">
            <canvas id="chart-distribucion-gastos"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Comparación por Concepto</h4>
          <div class="chart-wrapper">
            <canvas id="chart-comparacion-conceptos"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Evolución Mensual por Máquina</h4>
          <div class="chart-wrapper">
            <canvas id="chart-evolucion-mensual"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Top 10 Repuestos por Máquina</h4>
          <div class="chart-wrapper">
            <canvas id="chart-top-repuestos"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="resultados-container" id="comparacion-container">
      <h3>Análisis Comparativo</h3>
      <div class="comparison-container" id="comparison-container">
        <!-- La comparación se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container" id="detalle-maquina-container" style="display: none;">
      <div class="detalle-maquina">
        <div class="detalle-header">
          <h3 class="detalle-title">Detalle de Gastos</h3>
          <div class="detalle-patente" id="detalle-patente"></div>
        </div>
        <table class="tabla-resultados" id="tabla-detalle-maquina">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Producto</th>
              <th>Código</th>
              <th>Concepto</th>
              <th>Unidades</th>
              <th>Valor Unitario</th>
              <th>Valor Total</th>
              <th>Mecánico</th>
            </tr>
          </thead>
          <tbody>
            <!-- Los datos se cargarán dinámicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="connection-status" class="connection-status connection-loading" style="display: none;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a la base de datos...
    </div>

    <script>
      // Variables globales
      let supabaseClient;
      let maquinasBase = [];
      let datosMaquinas = null;
      let datosCompletos = null;
      let maquinaSeleccionada = null;
      let charts = {};
      let configuracionInforme = {
        mostrarEstadisticas: true,
        mostrarTarjetas: true,
        mostrarRanking: true,
        mostrarGraficos: true,
        mostrarComparacion: true,
        mostrarDetalle: true
      };
      let periodoSeleccionado = 'mes'; // Período por defecto

      // Función para inicializar Supabase
      async function inicializarSupabase() {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.style.display = 'block';

        try {
          // Configuración de Supabase - Reemplaza con tus credenciales
          const supabaseUrl = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';

          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

          // Verificar conexión obteniendo datos necesarios
          const maquinas = await obtenerMaquinas();

          connectionStatus.className = 'connection-status connection-success';
          connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a la base de datos';

          setTimeout(() => {
            connectionStatus.style.display = 'none';
          }, 3000);

          // Actualizar lista de máquinas
          if (maquinas && maquinas.length > 0) {
            maquinasBase = maquinas;
          }

          // Configurar fechas por defecto (último mes)
          const fechaFin = new Date();
          const fechaInicio = new Date();
          fechaInicio.setMonth(fechaInicio.getMonth() - 1);
          
          document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
          document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
          document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];

          // Cargar datos iniciales
          await cargarDatosMaquinas();

          return true;
        } catch (error) {
          console.error('Error al conectar con Supabase:', error);
          connectionStatus.className = 'connection-status connection-error';
          connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
          mostrarError(`Error al conectar con la base de datos: ${error.message}`);
          return false;
        }
      }

      // Función para obtener máquinas
      async function obtenerMaquinas() {
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('patente')
          .order('patente', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener datos de gastos por máquina
      async function obtenerDatosGastosPorMaquina(fechaInicio, fechaFin) {
        let query = supabaseClient
          .from('registros')
          .select('*')
          .eq('estado', 'salida')
          .gte('fecha', fechaInicio)
          .lte('fecha', fechaFin)
          .order('fecha', { ascending: false });

        const { data, error } = await query;

        if (error) throw error;
        return data;
      }

      // Función para calcular fechas según período seleccionado
      function calcularFechasPorPeriodo(periodo) {
        const fechaFin = new Date();
        let fechaInicio = new Date();
        
        switch(periodo) {
          case 'dia':
            fechaInicio.setDate(fechaFin.getDate() - 1);
            break;
          case 'semana':
            fechaInicio.setDate(fechaFin.getDate() - 7);
            break;
          case 'mes':
            fechaInicio.setMonth(fechaFin.getMonth() - 1);
            break;
          case 'bimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 2);
            break;
          case 'trimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 3);
            break;
          case 'cuatrimestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 4);
            break;
          case 'semestre':
            fechaInicio.setMonth(fechaFin.getMonth() - 6);
            break;
          case 'anio':
            fechaInicio.setFullYear(fechaFin.getFullYear() - 1);
            break;
          case 'personalizado':
            // Para personalizado, usamos las fechas del formulario
            const fechaInicioInput = document.getElementById('fecha-inicio').value;
            const fechaFinInput = document.getElementById('fecha-fin').value;
            
            if (fechaInicioInput && fechaFinInput) {
              fechaInicio = new Date(fechaInicioInput);
              fechaFin = new Date(fechaFinInput);
            } else {
              // Por defecto, último mes
              fechaInicio.setMonth(fechaFin.getMonth() - 1);
            }
            break;
        }
        
        return {
          fechaInicio: fechaInicio.toISOString().split('T')[0],
          fechaFin: fechaFin.toISOString().split('T')[0]
        };
      }

      // Función para procesar datos por máquina
      function procesarDatosPorMaquina(datos) {
        const maquinasAgrupadas = {};
        let gastoTotalGlobal = 0;
        
        // Procesar cada movimiento
        datos.forEach(item => {
          const patente = item.patente || 'Sin patente';
          
          if (!maquinasAgrupadas[patente]) {
            maquinasAgrupadas[patente] = {
              patente: patente,
              movimientos: 0,
              unidades: 0,
              gastos: 0,
              conceptos: {},
              productos: {},
              fechas: [],
              detalles: []
            };
          }
          
          const maquina = maquinasAgrupadas[patente];
          maquina.movimientos++;
          maquina.unidades += item.unidades || 0;
          maquina.gastos += item.precio_total || 0;
          maquina.fechas.push(item.fecha);
          maquina.detalles.push(item);
          
          // Agrupar por concepto
          const concepto = item.concepto || 'Sin concepto';
          if (!maquina.conceptos[concepto]) {
            maquina.conceptos[concepto] = 0;
          }
          maquina.conceptos[concepto] += item.precio_total || 0;
          
          // Agrupar por producto
          const producto = item.nombre || 'Sin nombre';
          if (!maquina.productos[producto]) {
            maquina.productos[producto] = {
              unidades: 0,
              gastos: 0
            };
          }
          maquina.productos[producto].unidades += item.unidades || 0;
          maquina.productos[producto].gastos += item.precio_total || 0;
          
          gastoTotalGlobal += item.precio_total || 0;
        });

        // Calcular porcentajes y promedios
        Object.values(maquinasAgrupadas).forEach(maquina => {
          maquina.porcentajeTotal = gastoTotalGlobal > 0 ? (maquina.gastos / gastoTotalGlobal) * 100 : 0;
          maquina.costoPromedio = maquina.movimientos > 0 ? maquina.gastos / maquina.movimientos : 0;
          maquina.ultimaFecha = maquina.fechas.length > 0 ? 
            new Date(Math.max(...maquina.fechas.map(f => new Date(f)))) : null;
        });

        return {
          maquinas: maquinasAgrupadas,
          gastoTotalGlobal: gastoTotalGlobal,
          totalMovimientos: datos.length
        };
      }

      // Función para cargar datos de máquinas
      async function cargarDatosMaquinas() {
        try {
          // Obtener valores de filtros
          const ordenarPor = document.getElementById('ordenar-por').value;
          const mostrarTop = parseInt(document.getElementById('mostrar-top').value);

          // Calcular fechas según período
          const fechas = calcularFechasPorPeriodo(periodoSeleccionado);

          // Obtener datos
          const datos = await obtenerDatosGastosPorMaquina(fechas.fechaInicio, fechas.fechaFin);
          datosCompletos = datos;
          
          // Procesar datos por máquina
          const resultado = procesarDatosPorMaquina(datos);
          datosMaquinas = resultado.maquinas;

          // Ordenar máquinas
          let maquinasOrdenadas = Object.values(datosMaquinas);
          
          switch(ordenarPor) {
            case 'gastos':
              maquinasOrdenadas.sort((a, b) => b.gastos - a.gastos);
              break;
            case 'movimientos':
              maquinasOrdenadas.sort((a, b) => b.movimientos - a.movimientos);
              break;
            case 'unidades':
              maquinasOrdenadas.sort((a, b) => b.unidades - a.unidades);
              break;
            case 'promedio':
              maquinasOrdenadas.sort((a, b) => b.costoPromedio - a.costoPromedio);
              break;
          }

          // Aplicar filtro de top si es necesario
          if (mostrarTop > 0) {
            maquinasOrdenadas = maquinasOrdenadas.slice(0, mostrarTop);
          }

          // Actualizar interfaz según configuración
          actualizarVistaInforme(maquinasOrdenadas, resultado);

        } catch (error) {
          console.error('Error al cargar datos de máquinas:', error);
          mostrarError('Error al cargar datos: ' + error.message);
        }
      }

      // Función para actualizar la vista según la configuración del informe
      function actualizarVistaInforme(maquinasOrdenadas, resultado) {
        // Mostrar/ocultar secciones según configuración
        document.getElementById('stats-container').style.display = 
          configuracionInforme.mostrarEstadisticas ? 'grid' : 'none';
        document.getElementById('tarjetas-container').style.display = 
          configuracionInforme.mostrarTarjetas ? 'block' : 'none';
        document.getElementById('ranking-container').style.display = 
          configuracionInforme.mostrarRanking ? 'block' : 'none';
        document.getElementById('graficos-container').style.display = 
          configuracionInforme.mostrarGraficos ? 'block' : 'none';
        document.getElementById('comparacion-container').style.display = 
          configuracionInforme.mostrarComparacion ? 'block' : 'none';
        document.getElementById('detalle-maquina-container').style.display = 
          configuracionInforme.mostrarDetalle && maquinaSeleccionada ? 'block' : 'none';

        // Actualizar contenido de cada sección
        if (configuracionInforme.mostrarEstadisticas) {
          actualizarEstadisticas(resultado);
        }
        
        if (configuracionInforme.mostrarTarjetas) {
          actualizarTarjetasMaquinas(maquinasOrdenadas, resultado.gastoTotalGlobal);
        }
        
        if (configuracionInforme.mostrarRanking) {
          actualizarTablaRanking(maquinasOrdenadas, resultado.gastoTotalGlobal);
        }
        
        if (configuracionInforme.mostrarGraficos) {
          actualizarGraficos(maquinasOrdenadas, resultado.gastoTotalGlobal);
        }
        
        if (configuracionInforme.mostrarComparacion) {
          actualizarComparacion(maquinasOrdenadas);
        }
      }

      // Función para actualizar estadísticas
      function actualizarEstadisticas(resultado) {
        const statsContainer = document.getElementById('stats-container');

        if (!resultado || Object.keys(resultado.maquinas).length === 0) {
          statsContainer.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron datos</p>';
          return;
        }

        const totalMaquinas = Object.keys(resultado.maquinas).length;
        const promedioPorMaquina = resultado.gastoTotalGlobal / totalMaquinas;
        const maquinaMasCostosa = Object.values(resultado.maquinas).reduce((max, maquina) => 
          maquina.gastos > max.gastos ? maquina : max, {gastos: 0});

        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${totalMaquinas}</div>
            <div class="stat-label">Máquinas Activas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${resultado.gastoTotalGlobal.toLocaleString('es-CL')}</div>
            <div class="stat-label">Gastos Totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${resultado.totalMovimientos}</div>
            <div class="stat-label">Total Movimientos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${promedioPorMaquina.toLocaleString('es-CL', {maximumFractionDigits: 0})}</div>
            <div class="stat-label">Promedio por Máquina</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${maquinaMasCostosa.patente}</div>
            <div class="stat-label">Máquina Más Costosa</div>
          </div>
        `;
      }

      // Función para actualizar tarjetas de máquinas
      function actualizarTarjetasMaquinas(maquinas, gastoTotalGlobal) {
        const maquinasGrid = document.getElementById('maquinas-grid');
        maquinasGrid.innerHTML = '';

        if (maquinas.length === 0) {
          maquinasGrid.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron máquinas</p>';
          return;
        }

        maquinas.forEach((maquina, index) => {
          const card = document.createElement('div');
          card.className = 'maquina-card';
          card.style.background = getGradientByIndex(index);
          card.onclick = () => mostrarDetalleMaquina(maquina.patente);

          const porcentaje = (maquina.gastos / gastoTotalGlobal) * 100;
          const ranking = index + 1;

          card.innerHTML = `
            <div class="maquina-header">
              <div class="maquina-patente">${maquina.patente}</div>
              <div class="maquina-ranking">#${ranking}</div>
            </div>
            <div class="maquina-stats">
              <div class="maquina-stat">
                <div class="maquina-stat-value">$${maquina.gastos.toLocaleString('es-CL')}</div>
                <div class="maquina-stat-label">Gastos Totales</div>
              </div>
              <div class="maquina-stat">
                <div class="maquina-stat-value">${maquina.movimientos}</div>
                <div class="maquina-stat-label">Movimientos</div>
              </div>
            </div>
            <div class="maquina-progress">
              <div class="maquina-progress-bar" style="width: ${Math.min(porcentaje, 100)}%"></div>
            </div>
            <div class="maquina-percentage">${porcentaje.toFixed(1)}% del total</div>
          `;

          maquinasGrid.appendChild(card);
        });
      }

      // Función para actualizar tabla de ranking
      function actualizarTablaRanking(maquinas, gastoTotalGlobal) {
        const tbody = document.getElementById('tabla-ranking').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (maquinas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No se encontraron datos</td></tr>';
          return;
        }

        maquinas.forEach((maquina, index) => {
          const row = tbody.insertRow();
          const ranking = index + 1;
          
          // Posición
          const posicionCell = row.insertCell(0);
          if (ranking <= 3) {
            posicionCell.innerHTML = `<div class="top-${ranking}">${ranking}</div>`;
          } else {
            posicionCell.textContent = ranking;
          }
          
          // Patente
          const patenteCell = row.insertCell(1);
          patenteCell.textContent = maquina.patente;
          
          // Gastos Totales
          const gastosCell = row.insertCell(2);
          gastosCell.textContent = `$${maquina.gastos.toLocaleString('es-CL')}`;
          
          // Movimientos
          const movimientosCell = row.insertCell(3);
          movimientosCell.textContent = maquina.movimientos;
          
          // Unidades
          const unidadesCell = row.insertCell(4);
          unidadesCell.textContent = maquina.unidades;
          
          // Costo Promedio
          const promedioCell = row.insertCell(5);
          promedioCell.textContent = `$${maquina.costoPromedio.toLocaleString('es-CL', {maximumFractionDigits: 0})}`;
          
          // Porcentaje del Total
          const porcentajeCell = row.insertCell(6);
          const porcentaje = (maquina.gastos / gastoTotalGlobal) * 100;
          porcentajeCell.textContent = `${porcentaje.toFixed(1)}%`;
        });
      }

      // Función para actualizar comparación
      function actualizarComparacion(maquinas) {
        const comparisonContainer = document.getElementById('comparison-container');

        if (maquinas.length === 0) {
          comparisonContainer.innerHTML = '<p style="text-align: center; width: 100%;">No hay datos para comparar</p>';
          return;
        }

        // Tomar las 3 máquinas con más gastos para comparación
        const topMaquinas = maquinas.slice(0, 3);
        const totalGastos = topMaquinas.reduce((sum, m) => sum + m.gastos, 0);

        comparisonContainer.innerHTML = topMaquinas.map(maquina => {
          const porcentaje = (maquina.gastos / totalGastos) * 100;
          const conceptos = Object.keys(maquina.conceptos).slice(0, 3); // Top 3 conceptos
          
          return `
            <div class="comparison-card">
              <h4 class="comparison-title">${maquina.patente}</h4>
              <div class="comparison-item">
                <span class="comparison-label">Gastos Totales:</span>
                <span class="comparison-value">$${maquina.gastos.toLocaleString('es-CL')}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Porcentaje:</span>
                <span class="comparison-value">${porcentaje.toFixed(1)}%</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Movimientos:</span>
                <span class="comparison-value">${maquina.movimientos}</span>
              </div>
              <div class="comparison-item">
                <span class="comparison-label">Conceptos Principales:</span>
                <span class="comparison-value">${conceptos.join(', ')}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Función para mostrar detalle de máquina
      function mostrarDetalleMaquina(patente) {
        if (!configuracionInforme.mostrarDetalle) return;
        
        maquinaSeleccionada = patente;
        const maquina = datosMaquinas[patente];
        
        if (!maquina) return;

        // Actualizar header del detalle
        document.getElementById('detalle-patente').textContent = patente;
        
        // Actualizar tabla de detalle
        const tbody = document.getElementById('tabla-detalle-maquina').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        maquina.detalles.forEach(item => {
          const row = tbody.insertRow();
          
          // Fecha
          const fechaCell = row.insertCell(0);
          fechaCell.textContent = item.fecha || '-';
          
          // Producto
          const productoCell = row.insertCell(1);
          productoCell.textContent = item.nombre || '-';
          
          // Código
          const codigoCell = row.insertCell(2);
          codigoCell.textContent = item.codigo || '-';
          
          // Concepto
          const conceptoCell = row.insertCell(3);
          conceptoCell.textContent = item.concepto || '-';
          
          // Unidades
          const unidadesCell = row.insertCell(4);
          unidadesCell.textContent = item.unidades || '0';
          
          // Valor Unitario
          const valorUnitarioCell = row.insertCell(5);
          const precioUnitario = item.unidades > 0 ? (item.precio_total || 0) / item.unidades : 0;
          valorUnitarioCell.textContent = `$${precioUnitario.toLocaleString('es-CL', {maximumFractionDigits: 2})}`;
          
          // Valor Total
          const valorTotalCell = row.insertCell(6);
          valorTotalCell.textContent = `$${(item.precio_total || 0).toLocaleString('es-CL')}`;
          
          // Mecánico
          const mecanicoCell = row.insertCell(7);
          mecanicoCell.textContent = 'Mecánico'; // En implementación real, buscar por ID
        });

        // Mostrar contenedor de detalle
        document.getElementById('detalle-maquina-container').style.display = 'block';
        
        // Scroll al detalle
        document.getElementById('detalle-maquina-container').scrollIntoView({ 
          behavior: 'smooth' 
        });
      }

      // Función para actualizar gráficos
      function actualizarGraficos(maquinas, gastoTotalGlobal) {
        // Preparar datos para gráficos
        const datosGraficoDistribucion = prepararDatosDistribucionGastos(maquinas);
        const datosGraficoConceptos = prepararDatosComparacionConceptos(maquinas);
        const datosGraficoEvolucion = prepararDatosEvolucionMensual(maquinas);
        const datosGraficoRepuestos = prepararDatosTopRepuestos(maquinas);

        // Crear o actualizar gráficos
        crearGraficoDistribucionGastos(datosGraficoDistribucion);
        crearGraficoComparacionConceptos(datosGraficoConceptos);
        crearGraficoEvolucionMensual(datosGraficoEvolucion);
        crearGraficoTopRepuestos(datosGraficoRepuestos);
      }

      // Preparar datos para gráfico de distribución de gastos
      function prepararDatosDistribucionGastos(maquinas) {
        return {
          labels: maquinas.map(m => m.patente),
          datos: maquinas.map(m => m.gastos)
        };
      }

      // Preparar datos para gráfico de comparación por conceptos
      function prepararDatosComparacionConceptos(maquinas) {
        // Obtener todos los conceptos únicos
        const conceptos = new Set();
        maquinas.forEach(maquina => {
          Object.keys(maquina.conceptos).forEach(concepto => {
            conceptos.add(concepto);
          });
        });
        
        const datasets = Array.from(conceptos).map((concepto, index) => {
          return {
            label: concepto,
            data: maquinas.map(maquina => maquina.conceptos[concepto] || 0),
            backgroundColor: getColorByIndex(index, 0.7),
            borderColor: getColorByIndex(index, 1),
            borderWidth: 2
          };
        });

        return {
          labels: maquinas.map(m => m.patente),
          datasets: datasets
        };
      }

      // Preparar datos para gráfico de evolución mensual
      function prepararDatosEvolucionMensual(maquinas) {
        // Tomar las 5 máquinas con más gastos para el gráfico
        const topMaquinas = maquinas.slice(0, 5);
        const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        
        // En una implementación real, aquí se agruparían los datos por mes para cada máquina
        // Por simplicidad, generamos datos de ejemplo
        const datasets = topMaquinas.map((maquina, index) => {
          const datosEvolucion = meses.map(() => Math.random() * maquina.gastos / 12);
          
          return {
            label: maquina.patente,
            data: datosEvolucion,
            borderColor: getColorByIndex(index),
            backgroundColor: getColorByIndex(index, 0.1),
            borderWidth: 2,
            tension: 0.3
          };
        });
        
        return {
          labels: meses,
          datasets: datasets
        };
      }

      // Preparar datos para gráfico de top repuestos
      function prepararDatosTopRepuestos(maquinas) {
        // Agrupar todos los productos de todas las máquinas
        const todosProductos = {};
        
        maquinas.forEach(maquina => {
          Object.entries(maquina.productos).forEach(([producto, datos]) => {
            if (!todosProductos[producto]) {
              todosProductos[producto] = {
                unidades: 0,
                gastos: 0,
                maquinas: new Set()
              };
            }
            todosProductos[producto].unidades += datos.unidades;
            todosProductos[producto].gastos += datos.gastos;
            todosProductos[producto].maquinas.add(maquina.patente);
          });
        });

        // Ordenar por gastos y tomar los 10 primeros
        const topProductos = Object.entries(todosProductos)
          .sort((a, b) => b[1].gastos - a[1].gastos)
          .slice(0, 10);

        return {
          labels: topProductos.map(p => p[0]),
          datos: topProductos.map(p => p[1].gastos)
        };
      }

      // Función auxiliar para obtener gradientes
      function getGradientByIndex(index) {
        const gradients = [
          'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
          'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
          'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
          'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
          'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
          'linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)',
          'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)'
        ];
        return gradients[index % gradients.length];
      }

      // Función auxiliar para obtener colores
      function getColorByIndex(index, alpha = 1) {
        const colors = [
          `rgba(63, 114, 175, ${alpha})`,
          `rgba(231, 76, 60, ${alpha})`,
          `rgba(46, 204, 113, ${alpha})`,
          `rgba(243, 156, 18, ${alpha})`,
          `rgba(155, 89, 182, ${alpha})`,
          `rgba(52, 152, 219, ${alpha})`,
          `rgba(26, 188, 156, ${alpha})`,
          `rgba(241, 196, 15, ${alpha})`
        ];
        return colors[index % colors.length];
      }

      // Crear gráfico de distribución de gastos
      function crearGraficoDistribucionGastos(datos) {
        const ctx = document.getElementById('chart-distribucion-gastos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.distribucionGastos) {
          charts.distribucionGastos.destroy();
        }
        
        charts.distribucionGastos = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: datos.labels,
            datasets: [{
              data: datos.datos,
              backgroundColor: datos.labels.map((_, index) => getColorByIndex(index, 0.7)),
              borderColor: datos.labels.map((_, index) => getColorByIndex(index, 1)),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              }
            }
          }
        });
      }

      // Crear gráfico de comparación por conceptos
      function crearGraficoComparacionConceptos(datos) {
        const ctx = document.getElementById('chart-comparacion-conceptos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.comparacionConceptos) {
          charts.comparacionConceptos.destroy();
        }
        
        charts.comparacionConceptos = new Chart(ctx, {
          type: 'bar',
          data: datos,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos ($)'
                },
                stacked: true
              },
              x: {
                stacked: true
              }
            }
          }
        });
      }

      // Crear gráfico de evolución mensual
      function crearGraficoEvolucionMensual(datos) {
        const ctx = document.getElementById('chart-evolucion-mensual').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.evolucionMensual) {
          charts.evolucionMensual.destroy();
        }
        
        charts.evolucionMensual = new Chart(ctx, {
          type: 'line',
          data: datos,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos ($)'
                }
              }
            }
          }
        });
      }

      // Crear gráfico de top repuestos
      function crearGraficoTopRepuestos(datos) {
        const ctx = document.getElementById('chart-top-repuestos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.topRepuestos) {
          charts.topRepuestos.destroy();
        }
        
        charts.topRepuestos = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Gastos por Producto',
              data: datos.datos,
              backgroundColor: 'rgba(63, 114, 175, 0.7)',
              borderColor: 'rgba(63, 114, 175, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos ($)'
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
      }

      // Función para manejar la selección de período
      function seleccionarPeriodo(periodo) {
        // Actualizar variable global
        periodoSeleccionado = periodo;
        
        // Actualizar estado visual de los botones
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Activar el botón seleccionado
        document.querySelector(`.periodo-btn[data-periodo="${periodo}"]`).classList.add('active');
        
        // Mostrar/ocultar campos de fecha según el período
        if (periodo === 'personalizado') {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'block';
          document.getElementById('fecha-fin-group').style.display = 'block';
        } else if (periodo === 'dia') {
          document.getElementById('fecha-personalizada-group').style.display = 'block';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        } else {
          document.getElementById('fecha-personalizada-group').style.display = 'none';
          document.getElementById('fecha-inicio-group').style.display = 'none';
          document.getElementById('fecha-fin-group').style.display = 'none';
        }
      }

      // Función para mostrar modal de selección de datos
      function mostrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'flex';
        
        // Establecer valores actuales en los checkboxes
        document.getElementById('mostrar-estadisticas').checked = configuracionInforme.mostrarEstadisticas;
        document.getElementById('mostrar-tarjetas').checked = configuracionInforme.mostrarTarjetas;
        document.getElementById('mostrar-ranking').checked = configuracionInforme.mostrarRanking;
        document.getElementById('mostrar-graficos').checked = configuracionInforme.mostrarGraficos;
        document.getElementById('mostrar-comparacion').checked = configuracionInforme.mostrarComparacion;
        document.getElementById('mostrar-detalle').checked = configuracionInforme.mostrarDetalle;
      }

      // Función para cerrar modal de selección de datos
      function cerrarModalSeleccionDatos() {
        document.getElementById('modal-seleccion-datos').style.display = 'none';
      }

      // Función para generar informe con la configuración seleccionada
      function generarInforme() {
        // Obtener configuración seleccionada
        configuracionInforme = {
          mostrarEstadisticas: document.getElementById('mostrar-estadisticas').checked,
          mostrarTarjetas: document.getElementById('mostrar-tarjetas').checked,
          mostrarRanking: document.getElementById('mostrar-ranking').checked,
          mostrarGraficos: document.getElementById('mostrar-graficos').checked,
          mostrarComparacion: document.getElementById('mostrar-comparacion').checked,
          mostrarDetalle: document.getElementById('mostrar-detalle').checked
        };

        // Cerrar modal
        cerrarModalSeleccionDatos();

        // Generar informe con la configuración seleccionada
        cargarDatosMaquinas();
        
        mostrarExito('Informe generado con éxito');
      }

      // Función para limpiar filtros
      function limpiarFiltros() {
        // Configurar período por defecto (mes)
        seleccionarPeriodo('mes');
        
        // Configurar fechas por defecto (último mes)
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setMonth(fechaInicio.getMonth() - 1);
        
        document.getElementById('fecha-personalizada').value = fechaFin.toISOString().split('T')[0];
        document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
        document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];
        
        document.getElementById('tipo-analisis').value = 'general';
        document.getElementById('ordenar-por').value = 'gastos';
        document.getElementById('mostrar-top').value = '0';
        
        // Ocultar detalle de máquina
        document.getElementById('detalle-maquina-container').style.display = 'none';
        
        // Cargar datos sin filtros
        cargarDatosMaquinas();
      }

      // Mostrar mensaje de error
      function mostrarError(mensaje) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = mensaje;
        errorElement.style.display = 'block';

        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }

      // Mostrar mensaje de éxito
      function mostrarExito(mensaje) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = mensaje;
        successElement.style.display = 'block';

        setTimeout(() => {
          successElement.style.display = 'none';
        }, 3000);
      }

      // Inicializar la aplicación cuando se cargue la página
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar eventos para los botones de período
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-periodo');
            seleccionarPeriodo(periodo);
          });
        });

        // Configurar eventos para cambios en filtros
        document.getElementById('tipo-analisis').addEventListener('change', function() {
          cargarDatosMaquinas();
        });

        document.getElementById('ordenar-por').addEventListener('change', function() {
          cargarDatosMaquinas();
        });

        document.getElementById('mostrar-top').addEventListener('change', function() {
          cargarDatosMaquinas();
        });

        await inicializarSupabase();
      });
    </script>
  </div>
</body>
</html>
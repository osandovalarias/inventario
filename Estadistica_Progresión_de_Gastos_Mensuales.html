<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Inventario - Progresión de Gastos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --color-primary: #3f72af;
      --color-secondary: #dbe2ef;
      --color-text: #112d4e;
      --color-accent: #2c5282;
      --color-success: #2ecc71;
      --color-error: #e74c3c;
      --color-warning: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      --header-bg-color: #2c5282;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #3f72af, #dbe2ef);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--color-text);
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background-color: var(--header-bg-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    h1, h2, h3 {
      text-align: center;
      color: white;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--color-secondary);
    }

    h2 {
      margin-top: 30px;
      font-size: 1.5rem;
    }

    h3 {
      text-align: left;
      color: var(--color-primary);
      border-bottom: none;
      padding-bottom: 0;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: white;
      padding: 5px;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .title-container {
      flex: 1;
    }

    .subtitle {
      text-align: center;
      color: #dbe2ef;
      margin-top: -10px;
      font-size: 1.1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--color-success);
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--color-error);
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-info {
      background: var(--color-primary);
    }

    .btn-info:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
    }

    .btn-print {
      background: #17a2b8;
    }

    .btn-print:hover {
      background: #138496;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .status-message {
      padding: 15px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      text-align: center;
      font-weight: 500;
    }

    .error {
      background-color: #f8d7da;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .success {
      background-color: #d4edda;
      color: var(--color-success);
      border-left: 4px solid var(--color-success);
    }

    .info {
      background-color: #e7f5ff;
      color: var(--color-primary);
      border-left: 4px solid var(--color-primary);
    }

    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      box-shadow: var(--box-shadow);
      z-index: 100;
    }

    .connection-success {
      background-color: var(--color-success);
      color: white;
    }

    .connection-error {
      background-color: var(--color-error);
      color: white;
    }

    .connection-loading {
      background-color: var(--color-primary);
      color: white;
    }

    .hidden {
      display: none;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--color-primary);
    }

    .input-group input, 
    .input-group select, 
    .input-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
    }

    .form-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .resultados-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-top: 20px;
    }

    .tabla-resultados {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .tabla-resultados th {
      background-color: var(--color-primary);
      color: white;
      padding: 10px;
      text-align: left;
    }

    .tabla-resultados td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tabla-resultados tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .tabla-resultados tr:hover {
      background-color: #f1f1f1;
    }

    /* Estilos para gráficos */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: var(--color-primary);
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    /* Estilos para filtros */
    .filters-container {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .periodo-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .periodo-btn {
      padding: 10px 20px;
      border: 1px solid var(--color-primary);
      background-color: white;
      color: var(--color-primary);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .periodo-btn.active {
      background-color: var(--color-primary);
      color: white;
    }

    .periodo-btn:hover {
      background-color: var(--color-secondary);
    }

    /* Estilos para estadísticas */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para indicadores de tendencia */
    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .trend-up {
      color: var(--color-success);
    }

    .trend-down {
      color: var(--color-error);
    }

    .trend-neutral {
      color: #666;
    }

    /* Estilos para métricas clave */
    .metricas-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .metrica-card {
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .metrica-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .metrica-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-primary);
    }

    .metrica-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--color-text);
      margin-bottom: 10px;
    }

    .metrica-comparison {
      font-size: 0.9rem;
      color: #666;
    }

    /* Estilos para tabla de evolución */
    .evolucion-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .evolucion-table th {
      background-color: var(--color-primary);
      color: white;
      padding: 12px;
      text-align: center;
    }

    .evolucion-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    .evolucion-table .periodo-header {
      background-color: var(--color-secondary);
      font-weight: bold;
    }

    .evolucion-table .total-row {
      background-color: #f8f9fa;
      font-weight: bold;
    }

    .evolucion-table .variacion-cell {
      font-weight: bold;
    }

    .variacion-positiva {
      color: var(--color-success);
    }

    .variacion-negativa {
      color: var(--color-error);
    }

    /* Estilos para proyección */
    .proyeccion-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .proyeccion-title {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .proyeccion-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .proyeccion-item {
      text-align: center;
    }

    .proyeccion-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .proyeccion-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    @media print {
      body {
        background: white;
        color: black;
        padding: 0;
      }

      .header-container {
        background-color: white !important;
        color: black !important;
        box-shadow: none;
        border: 1px solid #ddd;
      }

      h1, h2, h3 {
        color: black !important;
      }

      .btn, .btn-group {
        display: none !important;
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
      }

      .subtitle {
        color: #555 !important;
      }
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
      
      .chart-wrapper {
        height: 300px;
      }
      
      .filter-row {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .metricas-container {
        grid-template-columns: 1fr;
      }
      
      .proyeccion-content {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <div class="logo-container">
        <div class="logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div>
          <h1>Control de Inventario</h1>
          <div class="subtitle">Progresión de Gastos - Evolución Temporal</div>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.location.href='menu.html'">
          <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-print" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>

    <div id="error-message" class="status-message error" style="display: none;"></div>
    <div id="success-message" class="status-message success" style="display: none;"></div>

    <div class="filters-container">
      <h3>Configuración del Análisis Temporal</h3>
      <div class="filter-row">
        <div class="filter-group">
          <label for="fecha-inicio">Fecha de Inicio:</label>
          <input type="date" id="fecha-inicio">
        </div>
        <div class="filter-group">
          <label for="fecha-fin">Fecha de Fin:</label>
          <input type="date" id="fecha-fin">
        </div>
        <div class="filter-group">
          <label for="patente-filtro">Patente:</label>
          <select id="patente-filtro">
            <option value="">Todas las máquinas</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Agrupación Temporal:</label>
          <div class="periodo-selector">
            <button class="periodo-btn active" data-periodo="diario">Diario</button>
            <button class="periodo-btn" data-periodo="semanal">Semanal</button>
            <button class="periodo-btn" data-periodo="mensual">Mensual</button>
            <button class="periodo-btn" data-periodo="trimestral">Trimestral</button>
            <button class="periodo-btn" data-periodo="anual">Anual</button>
          </div>
        </div>
        <div class="filter-group">
          <label for="tipo-grafico">Tipo de Gráfico:</label>
          <select id="tipo-grafico">
            <option value="linea">Línea</option>
            <option value="area">Área</option>
            <option value="barra">Barras</option>
          </select>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="limpiarFiltros()">
          <i class="fas fa-times"></i> Limpiar
        </button>
        <button class="btn btn-primary" onclick="cargarDatosProgresion()">
          <i class="fas fa-chart-line"></i> Generar Reporte
        </button>
      </div>
    </div>

    <div class="metricas-container" id="metricas-container">
      <!-- Las métricas se cargarán dinámicamente -->
    </div>

    <div class="resultados-container">
      <h3>Evolución de Gastos en el Tiempo</h3>
      <div class="charts-container">
        <div class="chart-card">
          <h4 class="chart-title">Progresión de Gastos Totales</h4>
          <div class="chart-wrapper">
            <canvas id="chart-progresion-gastos"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Comparación por Concepto</h4>
          <div class="chart-wrapper">
            <canvas id="chart-comparacion-conceptos"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Distribución Acumulada</h4>
          <div class="chart-wrapper">
            <canvas id="chart-acumulado"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h4 class="chart-title">Tendencia y Proyección</h4>
          <div class="chart-wrapper">
            <canvas id="chart-tendencia"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="resultados-container">
      <h3>Proyección de Gastos</h3>
      <div class="proyeccion-card" id="proyeccion-container">
        <!-- La proyección se cargará dinámicamente -->
      </div>
    </div>

    <div class="resultados-container">
      <h3>Resumen por Período</h3>
      <table class="evolucion-table" id="tabla-evolucion">
        <thead>
          <tr>
            <th>Período</th>
            <th>Movimientos</th>
            <th>Unidades</th>
            <th>Gastos ($)</th>
            <th>Promedio Diario</th>
            <th>Variación</th>
            <th>Tendencia</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div class="resultados-container">
      <h3>Detalle de Gastos</h3>
      <table class="tabla-resultados" id="tabla-detalle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Patente</th>
            <th>Producto</th>
            <th>Concepto</th>
            <th>Unidades</th>
            <th>Valor Unitario</th>
            <th>Valor Total</th>
          </tr>
        </thead>
        <tbody>
          <!-- Los datos se cargarán dinámicamente -->
        </tbody>
      </table>
    </div>

    <div id="connection-status" class="connection-status connection-loading" style="display: none;">
      <i class="fas fa-circle-notch fa-spin"></i> Conectando a la base de datos...
    </div>

    <script>
      // Variables globales
      let supabaseClient;
      let maquinasBase = [];
      let currentPeriodo = 'mensual';
      let currentTipoGrafico = 'linea';
      let charts = {};
      let datosProgresion = null;
      let datosAgrupados = null;

      // Función para inicializar Supabase
      async function inicializarSupabase() {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.style.display = 'block';

        try {
          // Configuración de Supabase - Reemplaza con tus credenciales
          const supabaseUrl = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
          const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';

          supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

          // Verificar conexión obteniendo datos necesarios
          const maquinas = await obtenerMaquinas();

          connectionStatus.className = 'connection-status connection-success';
          connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i> Conectado a la base de datos';

          setTimeout(() => {
            connectionStatus.style.display = 'none';
          }, 3000);

          // Actualizar lista de patentes
          if (maquinas && maquinas.length > 0) {
            maquinasBase = maquinas;
            const selectPatente = document.getElementById('patente-filtro');
            maquinas.forEach(maquina => {
              const option = document.createElement('option');
              option.value = maquina.patente;
              option.textContent = maquina.patente;
              selectPatente.appendChild(option);
            });
          }

          // Configurar fechas por defecto (últimos 12 meses)
          const fechaFin = new Date();
          const fechaInicio = new Date();
          fechaInicio.setMonth(fechaInicio.getMonth() - 12);
          
          document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
          document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];

          // Cargar datos iniciales
          await cargarDatosProgresion();

          return true;
        } catch (error) {
          console.error('Error al conectar con Supabase:', error);
          connectionStatus.className = 'connection-status connection-error';
          connectionStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
          mostrarError(`Error al conectar con la base de datos: ${error.message}`);
          return false;
        }
      }

      // Función para obtener máquinas
      async function obtenerMaquinas() {
        const { data, error } = await supabaseClient
          .from('maquinas')
          .select('patente')
          .order('patente', { ascending: true });

        if (error) throw error;
        return data;
      }

      // Función para obtener datos de progresión de gastos
      async function obtenerDatosProgresion(fechaInicio, fechaFin, patente = '') {
        let query = supabaseClient
          .from('registros')
          .select('*')
          .eq('estado', 'salida')
          .gte('fecha', fechaInicio)
          .lte('fecha', fechaFin)
          .order('fecha', { ascending: true });

        if (patente) {
          query = query.eq('patente', patente);
        }

        const { data, error } = await query;

        if (error) throw error;
        return data;
      }

      // Función para agrupar datos por período
      function agruparDatosPorPeriodo(datos, periodo) {
        const agrupados = {};
        
        datos.forEach(item => {
          const fecha = new Date(item.fecha);
          let clave;
          
          switch(periodo) {
            case 'diario':
              clave = fecha.toISOString().split('T')[0]; // YYYY-MM-DD
              break;
            case 'semanal':
              // Obtener lunes de la semana
              const lunes = new Date(fecha);
              lunes.setDate(fecha.getDate() - fecha.getDay() + 1);
              clave = `Sem ${lunes.toISOString().split('T')[0]}`;
              break;
            case 'mensual':
              clave = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
              break;
            case 'trimestral':
              const trimestre = Math.floor(fecha.getMonth() / 3) + 1;
              clave = `T${trimestre} ${fecha.getFullYear()}`;
              break;
            case 'anual':
              clave = fecha.getFullYear().toString();
              break;
          }
          
          if (!agrupados[clave]) {
            agrupados[clave] = {
              movimientos: 0,
              unidades: 0,
              gastos: 0,
              conceptos: {},
              fechas: []
            };
          }
          
          agrupados[clave].movimientos++;
          agrupados[clave].unidades += item.unidades || 0;
          agrupados[clave].gastos += item.precio_total || 0;
          agrupados[clave].fechas.push(item.fecha);
          
          // Agrupar por concepto
          const concepto = item.concepto || 'Sin concepto';
          if (!agrupados[clave].conceptos[concepto]) {
            agrupados[clave].conceptos[concepto] = 0;
          }
          agrupados[clave].conceptos[concepto] += item.precio_total || 0;
        });

        return agrupados;
      }

      // Función para cargar datos de progresión
      async function cargarDatosProgresion() {
        try {
          // Obtener valores de filtros
          const fechaInicio = document.getElementById('fecha-inicio').value;
          const fechaFin = document.getElementById('fecha-fin').value;
          const patente = document.getElementById('patente-filtro').value;
          currentTipoGrafico = document.getElementById('tipo-grafico').value;

          if (!fechaInicio || !fechaFin) {
            mostrarError('Por favor seleccione un rango de fechas');
            return;
          }

          // Obtener datos
          datosProgresion = await obtenerDatosProgresion(fechaInicio, fechaFin, patente);
          
          // Agrupar datos por período
          datosAgrupados = agruparDatosPorPeriodo(datosProgresion, currentPeriodo);

          // Actualizar interfaz
          actualizarMetricas();
          actualizarTablaEvolucion();
          actualizarTablaDetalle();
          actualizarProyeccion();
          actualizarGraficos();

        } catch (error) {
          console.error('Error al cargar datos de progresión:', error);
          mostrarError('Error al cargar datos: ' + error.message);
        }
      }

      // Función para actualizar métricas clave
      function actualizarMetricas() {
        const metricasContainer = document.getElementById('metricas-container');

        if (!datosProgresion || datosProgresion.length === 0) {
          metricasContainer.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron datos</p>';
          return;
        }

        // Calcular métricas
        const totalMovimientos = datosProgresion.length;
        const totalUnidades = datosProgresion.reduce((sum, item) => sum + (item.unidades || 0), 0);
        const totalGastos = datosProgresion.reduce((sum, item) => sum + (item.precio_total || 0), 0);
        
        // Calcular promedios
        const fechaInicio = new Date(document.getElementById('fecha-inicio').value);
        const fechaFin = new Date(document.getElementById('fecha-fin').value);
        const diasTotales = Math.ceil((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1;
        
        const promedioDiario = totalGastos / diasTotales;
        const promedioMovimiento = totalMovimientos > 0 ? totalGastos / totalMovimientos : 0;

        // Calcular tendencia (comparar primera y segunda mitad del período)
        const mitad = Math.floor(datosProgresion.length / 2);
        const primeraMitad = datosProgresion.slice(0, mitad);
        const segundaMitad = datosProgresion.slice(mitad);
        
        const gastosPrimeraMitad = primeraMitad.reduce((sum, item) => sum + (item.precio_total || 0), 0);
        const gastosSegundaMitad = segundaMitad.reduce((sum, item) => sum + (item.precio_total || 0), 0);
        
        const tendencia = gastosSegundaMitad > gastosPrimeraMitad ? 'alza' : 
                         gastosSegundaMitad < gastosPrimeraMitad ? 'baja' : 'estable';

        // Crear HTML de métricas
        metricasContainer.innerHTML = `
          <div class="metrica-card">
            <div class="metrica-header">
              <div class="metrica-title">Gastos Totales</div>
              <div class="trend-indicator ${tendencia === 'alza' ? 'trend-up' : tendencia === 'baja' ? 'trend-down' : 'trend-neutral'}">
                <i class="fas ${tendencia === 'alza' ? 'fa-arrow-up' : tendencia === 'baja' ? 'fa-arrow-down' : 'fa-minus'}"></i>
              </div>
            </div>
            <div class="metrica-value">$${totalGastos.toLocaleString('es-CL')}</div>
            <div class="metrica-comparison">${totalMovimientos} movimientos</div>
          </div>
          <div class="metrica-card">
            <div class="metrica-header">
              <div class="metrica-title">Promedio Diario</div>
            </div>
            <div class="metrica-value">$${promedioDiario.toLocaleString('es-CL', {maximumFractionDigits: 0})}</div>
            <div class="metrica-comparison">En ${diasTotales} días</div>
          </div>
          <div class="metrica-card">
            <div class="metrica-header">
              <div class="metrica-title">Costo por Movimiento</div>
            </div>
            <div class="metrica-value">$${promedioMovimiento.toLocaleString('es-CL', {maximumFractionDigits: 0})}</div>
            <div class="metrica-comparison">${totalUnidades} unidades totales</div>
          </div>
        `;
      }

      // Función para actualizar tabla de evolución
      function actualizarTablaEvolucion() {
        const tbody = document.getElementById('tabla-evolucion').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (!datosAgrupados || Object.keys(datosAgrupados).length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No se encontraron datos</td></tr>';
          return;
        }

        const periodos = Object.keys(datosAgrupados).sort();
        let gastoAnterior = 0;
        let gastoAcumulado = 0;

        periodos.forEach((periodo, index) => {
          const datos = datosAgrupados[periodo];
          const promedioDiario = datos.movimientos > 0 ? datos.gastos / datos.movimientos : 0;
          
          // Calcular variación
          let variacion = 0;
          let tendencia = 'neutral';
          
          if (gastoAnterior > 0) {
            variacion = ((datos.gastos - gastoAnterior) / gastoAnterior) * 100;
            tendencia = variacion > 5 ? 'alza' : variacion < -5 ? 'baja' : 'estable';
          }
          
          gastoAcumulado += datos.gastos;
          gastoAnterior = datos.gastos;

          const row = tbody.insertRow();
          
          // Período
          const periodoCell = row.insertCell(0);
          periodoCell.textContent = periodo;
          
          // Movimientos
          const movimientosCell = row.insertCell(1);
          movimientosCell.textContent = datos.movimientos;
          
          // Unidades
          const unidadesCell = row.insertCell(2);
          unidadesCell.textContent = datos.unidades;
          
          // Gastos
          const gastosCell = row.insertCell(3);
          gastosCell.textContent = `$${datos.gastos.toLocaleString('es-CL')}`;
          
          // Promedio Diario
          const promedioCell = row.insertCell(4);
          promedioCell.textContent = `$${promedioDiario.toLocaleString('es-CL', {maximumFractionDigits: 0})}`;
          
          // Variación
          const variacionCell = row.insertCell(5);
          variacionCell.className = `variacion-cell ${variacion > 0 ? 'variacion-positiva' : 'variacion-negativa'}`;
          if (index > 0) {
            variacionCell.textContent = `${variacion > 0 ? '+' : ''}${variacion.toFixed(1)}%`;
          } else {
            variacionCell.textContent = '-';
          }
          
          // Tendencia
          const tendenciaCell = row.insertCell(6);
          if (index > 0) {
            tendenciaCell.innerHTML = `
              <div class="trend-indicator ${tendencia === 'alza' ? 'trend-up' : tendencia === 'baja' ? 'trend-down' : 'trend-neutral'}">
                <i class="fas ${tendencia === 'alza' ? 'fa-arrow-up' : tendencia === 'baja' ? 'fa-arrow-down' : 'fa-minus'}"></i>
                ${tendencia}
              </div>
            `;
          } else {
            tendenciaCell.textContent = '-';
          }
        });

        // Agregar fila de totales
        const totalRow = tbody.insertRow();
        totalRow.className = 'total-row';
        
        const totalPeriodoCell = totalRow.insertCell(0);
        totalPeriodoCell.textContent = 'TOTAL';
        totalPeriodoCell.colSpan = 1;
        
        const totalMovimientosCell = totalRow.insertCell(1);
        totalMovimientosCell.textContent = Object.values(datosAgrupados).reduce((sum, d) => sum + d.movimientos, 0);
        
        const totalUnidadesCell = totalRow.insertCell(2);
        totalUnidadesCell.textContent = Object.values(datosAgrupados).reduce((sum, d) => sum + d.unidades, 0);
        
        const totalGastosCell = totalRow.insertCell(3);
        totalGastosCell.textContent = `$${gastoAcumulado.toLocaleString('es-CL')}`;
        
        const totalPromedioCell = totalRow.insertCell(4);
        totalPromedioCell.textContent = '-';
        
        const totalVariacionCell = totalRow.insertCell(5);
        totalVariacionCell.textContent = '-';
        
        const totalTendenciaCell = totalRow.insertCell(6);
        totalTendenciaCell.textContent = '-';
      }

      // Función para actualizar tabla de detalle
      function actualizarTablaDetalle() {
        const tbody = document.getElementById('tabla-detalle').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';

        if (!datosProgresion || datosProgresion.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No se encontraron datos</td></tr>';
          return;
        }

        // Mostrar solo los últimos 50 movimientos para no sobrecargar la tabla
        const datosMostrar = datosProgresion.slice(-50);

        datosMostrar.forEach(item => {
          const row = tbody.insertRow();
          
          // Fecha
          const fechaCell = row.insertCell(0);
          fechaCell.textContent = item.fecha || '-';
          
          // Patente
          const patenteCell = row.insertCell(1);
          patenteCell.textContent = item.patente || '-';
          
          // Producto
          const productoCell = row.insertCell(2);
          productoCell.textContent = item.nombre || '-';
          
          // Concepto
          const conceptoCell = row.insertCell(3);
          conceptoCell.textContent = item.concepto || '-';
          
          // Unidades
          const unidadesCell = row.insertCell(4);
          unidadesCell.textContent = item.unidades || '0';
          
          // Valor Unitario
          const valorUnitarioCell = row.insertCell(5);
          const precioUnitario = item.unidades > 0 ? (item.precio_total || 0) / item.unidades : 0;
          valorUnitarioCell.textContent = `$${precioUnitario.toLocaleString('es-CL', {maximumFractionDigits: 2})}`;
          
          // Valor Total
          const valorTotalCell = row.insertCell(6);
          valorTotalCell.textContent = `$${(item.precio_total || 0).toLocaleString('es-CL')}`;
        });
      }

      // Función para actualizar proyección
      function actualizarProyeccion() {
        const proyeccionContainer = document.getElementById('proyeccion-container');

        if (!datosAgrupados || Object.keys(datosAgrupados).length === 0) {
          proyeccionContainer.innerHTML = '<p style="text-align: center;">No hay suficientes datos para proyección</p>';
          return;
        }

        const periodos = Object.keys(datosAgrupados).sort();
        const ultimosPeriodos = periodos.slice(-6); // Últimos 6 períodos para calcular tendencia
        
        const gastos = ultimosPeriodos.map(p => datosAgrupados[p].gastos);
        
        // Calcular tendencia lineal simple
        let sumaX = 0, sumaY = 0, sumaXY = 0, sumaX2 = 0;
        const n = gastos.length;
        
        gastos.forEach((gasto, index) => {
          sumaX += index;
          sumaY += gasto;
          sumaXY += index * gasto;
          sumaX2 += index * index;
        });
        
        const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
        const intercepto = (sumaY - pendiente * sumaX) / n;
        
        // Proyección para el próximo período
        const proyeccion = pendiente * n + intercepto;
        const crecimiento = pendiente > 0 ? 'crecimiento' : 'decrecimiento';
        const porcentajeCrecimiento = ((pendiente / (sumaY / n)) * 100).toFixed(1);

        proyeccionContainer.innerHTML = `
          <div class="proyeccion-title">
            <i class="fas fa-chart-line"></i> Proyección del Próximo Período
          </div>
          <div class="proyeccion-content">
            <div class="proyeccion-item">
              <div class="proyeccion-value">$${proyeccion.toLocaleString('es-CL', {maximumFractionDigits: 0})}</div>
              <div class="proyeccion-label">Gasto Esperado</div>
            </div>
            <div class="proyeccion-item">
              <div class="proyeccion-value">${Math.abs(porcentajeCrecimiento)}%</div>
              <div class="proyeccion-label">Tasa de ${crecimiento}</div>
            </div>
            <div class="proyeccion-item">
              <div class="proyeccion-value">${pendiente > 0 ? '↗' : '↘'}</div>
              <div class="proyeccion-label">Tendencia</div>
            </div>
          </div>
        `;
      }

      // Función para actualizar gráficos
      function actualizarGraficos() {
        // Preparar datos para gráficos
        const datosGraficoProgresion = prepararDatosProgresionGastos();
        const datosGraficoConceptos = prepararDatosComparacionConceptos();
        const datosGraficoAcumulado = prepararDatosAcumulado();
        const datosGraficoTendencia = prepararDatosTendencia();

        // Crear o actualizar gráficos
        crearGraficoProgresionGastos(datosGraficoProgresion);
        crearGraficoComparacionConceptos(datosGraficoConceptos);
        crearGraficoAcumulado(datosGraficoAcumulado);
        crearGraficoTendencia(datosGraficoTendencia);
      }

      // Preparar datos para gráfico de progresión de gastos
      function prepararDatosProgresionGastos() {
        const periodos = Object.keys(datosAgrupados).sort();
        
        return {
          labels: periodos,
          datos: periodos.map(p => datosAgrupados[p].gastos)
        };
      }

      // Preparar datos para gráfico de comparación por conceptos
      function prepararDatosComparacionConceptos() {
        const periodos = Object.keys(datosAgrupados).sort();
        
        // Obtener todos los conceptos únicos
        const conceptos = new Set();
        periodos.forEach(p => {
          Object.keys(datosAgrupados[p].conceptos).forEach(concepto => {
            conceptos.add(concepto);
          });
        });
        
        const datasets = Array.from(conceptos).map((concepto, index) => {
          return {
            label: concepto,
            data: periodos.map(p => datosAgrupados[p].conceptos[concepto] || 0),
            backgroundColor: getColorByIndex(index, 0.7),
            borderColor: getColorByIndex(index, 1),
            borderWidth: 2
          };
        });

        return {
          labels: periodos,
          datasets: datasets
        };
      }

      // Preparar datos para gráfico acumulado
      function prepararDatosAcumulado() {
        const periodos = Object.keys(datosAgrupados).sort();
        let acumulado = 0;
        const datosAcumulados = periodos.map(p => {
          acumulado += datosAgrupados[p].gastos;
          return acumulado;
        });

        return {
          labels: periodos,
          datos: datosAcumulados
        };
      }

      // Preparar datos para gráfico de tendencia
      function prepararDatosTendencia() {
        const periodos = Object.keys(datosAgrupados).sort();
        const gastos = periodos.map(p => datosAgrupados[p].gastos);
        
        // Calcular línea de tendencia
        let sumaX = 0, sumaY = 0, sumaXY = 0, sumaX2 = 0;
        const n = gastos.length;
        
        gastos.forEach((gasto, index) => {
          sumaX += index;
          sumaY += gasto;
          sumaXY += index * gasto;
          sumaX2 += index * index;
        });
        
        const pendiente = (n * sumaXY - sumaX * sumaY) / (n * sumaX2 - sumaX * sumaX);
        const intercepto = (sumaY - pendiente * sumaX) / n;
        
        const tendencia = gastos.map((_, index) => pendiente * index + intercepto);

        return {
          labels: periodos,
          datasets: [
            {
              label: 'Gastos Reales',
              data: gastos,
              borderColor: 'rgba(63, 114, 175, 1)',
              backgroundColor: 'rgba(63, 114, 175, 0.1)',
              borderWidth: 2,
              tension: 0.3
            },
            {
              label: 'Línea de Tendencia',
              data: tendencia,
              borderColor: 'rgba(231, 76, 60, 1)',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 2,
              borderDash: [5, 5],
              tension: 0.3
            }
          ]
        };
      }

      // Función auxiliar para obtener colores
      function getColorByIndex(index, alpha = 1) {
        const colors = [
          `rgba(63, 114, 175, ${alpha})`,
          `rgba(231, 76, 60, ${alpha})`,
          `rgba(46, 204, 113, ${alpha})`,
          `rgba(243, 156, 18, ${alpha})`,
          `rgba(155, 89, 182, ${alpha})`,
          `rgba(52, 152, 219, ${alpha})`,
          `rgba(26, 188, 156, ${alpha})`,
          `rgba(241, 196, 15, ${alpha})`
        ];
        return colors[index % colors.length];
      }

      // Crear gráfico de progresión de gastos
      function crearGraficoProgresionGastos(datos) {
        const ctx = document.getElementById('chart-progresion-gastos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.progresionGastos) {
          charts.progresionGastos.destroy();
        }
        
        const chartType = currentTipoGrafico === 'barra' ? 'bar' : 
                         currentTipoGrafico === 'area' ? 'line' : 'line';
        
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Gastos ($)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Período'
              }
            }
          }
        };
        
        // Configuración adicional para gráfico de área
        if (currentTipoGrafico === 'area') {
          chartOptions.elements = {
            line: {
              fill: true
            }
          };
        }
        
        charts.progresionGastos = new Chart(ctx, {
          type: chartType,
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Gastos por Período',
              data: datos.datos,
              backgroundColor: currentTipoGrafico === 'area' ? 'rgba(63, 114, 175, 0.3)' : 'rgba(63, 114, 175, 0.7)',
              borderColor: 'rgba(63, 114, 175, 1)',
              borderWidth: 2,
              tension: 0.3
            }]
          },
          options: chartOptions
        });
      }

      // Crear gráfico de comparación por conceptos
      function crearGraficoComparacionConceptos(datos) {
        const ctx = document.getElementById('chart-comparacion-conceptos').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.comparacionConceptos) {
          charts.comparacionConceptos.destroy();
        }
        
        charts.comparacionConceptos = new Chart(ctx, {
          type: 'bar',
          data: datos,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos ($)'
                },
                stacked: true
              },
              x: {
                stacked: true
              }
            }
          }
        });
      }

      // Crear gráfico acumulado
      function crearGraficoAcumulado(datos) {
        const ctx = document.getElementById('chart-acumulado').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.acumulado) {
          charts.acumulado.destroy();
        }
        
        charts.acumulado = new Chart(ctx, {
          type: 'line',
          data: {
            labels: datos.labels,
            datasets: [{
              label: 'Gastos Acumulados',
              data: datos.datos,
              borderColor: 'rgba(46, 204, 113, 1)',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos Acumulados ($)'
                }
              }
            }
          }
        });
      }

      // Crear gráfico de tendencia
      function crearGraficoTendencia(datos) {
        const ctx = document.getElementById('chart-tendencia').getContext('2d');
        
        // Destruir gráfico anterior si existe
        if (charts.tendencia) {
          charts.tendencia.destroy();
        }
        
        charts.tendencia = new Chart(ctx, {
          type: 'line',
          data: datos,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Gastos ($)'
                }
              }
            }
          }
        });
      }

      // Función para limpiar filtros
      function limpiarFiltros() {
        // Configurar fechas por defecto (últimos 12 meses)
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setMonth(fechaInicio.getMonth() - 12);
        
        document.getElementById('fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
        document.getElementById('fecha-fin').value = fechaFin.toISOString().split('T')[0];
        
        document.getElementById('patente-filtro').value = '';
        document.getElementById('tipo-grafico').value = 'linea';
        
        // Restablecer período a mensual
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector('.periodo-btn[data-periodo="mensual"]').classList.add('active');
        currentPeriodo = 'mensual';
        
        // Cargar datos sin filtros
        cargarDatosProgresion();
      }

      // Mostrar mensaje de error
      function mostrarError(mensaje) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = mensaje;
        errorElement.style.display = 'block';

        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }

      // Mostrar mensaje de éxito
      function mostrarExito(mensaje) {
        const successElement = document.getElementById('success-message');
        successElement.textContent = mensaje;
        successElement.style.display = 'block';

        setTimeout(() => {
          successElement.style.display = 'none';
        }, 3000);
      }

      // Inicializar la aplicación cuando se cargue la página
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar eventos para botones de período
        document.querySelectorAll('.periodo-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.periodo-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriodo = this.dataset.periodo;
            
            // Cargar datos con el nuevo período
            cargarDatosProgresion();
          });
        });

        // Configurar evento para cambio de tipo de gráfico
        document.getElementById('tipo-grafico').addEventListener('change', function() {
          cargarDatosProgresion();
        });

        // Configurar evento para cambio de patente
        document.getElementById('patente-filtro').addEventListener('change', function() {
          cargarDatosProgresion();
        });

        await inicializarSupabase();
      });
    </script>
  </div>
</body>
</html>